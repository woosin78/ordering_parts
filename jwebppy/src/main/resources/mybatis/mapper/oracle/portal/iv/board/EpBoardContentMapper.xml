<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.jwebppy.portal.iv.board.mapper.EpBoardContentMapper">
	<resultMap type="EpBoardContentEntity" id="epBoardContentEntityMap">
		<id property="bcSeq" column="bc_seq" />
		<result property="bSeq" column="b_seq" />
		<result property="pSeq" column="p_seq" />
		<result property="order" column="order" />
		<result property="depth" column="depth" />
		<result property="uSeq" column="u_seq" />
		<result property="title" column="title" />
		<result property="htmlContent" column="html_content" />
		<result property="textContent" column="text_content" />
		<result property="fromView" column="from_view" />
		<result property="toView" column="to_view" />		
		<result property="views" column="views" />
		<result property="writer" column="writer" />
		<result property="fgDelete" column="fg_delete" />
		<result property="regUsername" column="reg_username" />
		<result property="regDate" column="reg_date" />
		<result property="modUsername" column="mod_username" />
		<result property="modDate" column="mod_date" />
		<association property="board" foreignColumn="b_seq" column="b_seq" javaType="EpBoardEntity" select="org.jwebppy.portal.iv.board.mapper.EpBoardMapper.findBoard" />
	</resultMap>

	<insert id="insert" parameterType="EpBoardContentEntity">
		insert into ep_board_content (bc_seq, b_seq, p_seq, sort, depth, u_seq, title, html_content, text_content, from_view, to_view, views, writer, fg_delete, reg_username, reg_date) values (
			#{bcSeq}, #{bSeq}, nvl(#{pSeq}, #{bcSeq}), 0, 0, #{uSeq}, #{title}, #{htmlContent}, #{textContent}, #{fromView}, #{toView}, 0, #{writer}, 'N', #{regUsername}, #{regDate}
		)
	</insert>
	
	<update id="update" parameterType="EpBoardContentEntity">
		update ep_board_content set
			title=#{title},
			html_content=#{htmlContent},
			text_content=#{textContent},
			from_view=#{fromView},
			to_view=#{toView},
			mod_username=#{modUsername},
			mod_date=#{modDate}				
		where
			bc_seq=#{bcSeq}
	</update>
	
	<update id="updatePSeq" parameterType="EpBoardContentEntity">
		update ep_board_content set p_seq=#{pSeq} where bc_seq=#{bcSeq}
	</update>	
	
	<update id="updatePlusViews">
		update ep_board_content set
			views=views+1
		where
			bc_seq=#{bcSeq}
	</update>
	
	<update id="updateForReply">
		update ep_board_content set
			sort=sort+1,
			depth=depth+1				
		where
			p_seq=#{pSeq}
			and bc_seq>#{pSeq}
	</update>
	
	<update id="delete" parameterType="EpBoardContentEntity">
		update ep_board_content set
			fg_delete='Y',
			mod_username=#{modUsername},
			mod_date=#{modDate}		
		where
			bc_seq=#{bcSeq}
	</update>

	<select id="findBoardContent" parameterType="EpBoardContentSearchDto" resultMap="epBoardContentEntityMap">
		select
		a.*
		from
		ep_board_content a
		where
		a.bc_seq=#{bcSeq}
		and a.fg_delete='N'
	</select>
	
	<select id="findBoardContents" parameterType="EpBoardContentSearchDto" resultMap="epBoardContentEntityMap">
		select
		total_count-(rownum-1) no,
		z.*
		from
		(
			select
			count(*) over() as total_count,
			a.*
			from
			ep_board_content a
			where
			a.b_seq=#{bSeq}
			and a.fg_delete='N'
			
			<if test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(title)">
				and upper(a.title) like '%'||upper(#{title})||'%'
			</if>
			
			<if test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(writer)">
				and upper(a.writer) like '%'||upper(#{writer})||'%'
			</if>
			
			<choose>
				<when test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(fromRegDate) and @org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(toRegDate)">
					and a.reg_date <![CDATA[>=]]> '${@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@dateFormat(fromRegDate, 'FROM')}' and a.reg_date <![CDATA[<]]> '${@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@dateFormat(toRegDate, 'TO')}'
				</when>
				<when test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(fromRegDate)">
					and a.reg_date <![CDATA[>=]]> '${@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@dateFormat(fromRegDate, 'FROM')}'
				</when>
				<when test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(toRegDate)">
					and a.reg_date <![CDATA[<]]> '${@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@dateFormat(toRegDate, 'TO')}'
				</when>
			</choose>
			
			<choose>
				<when test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(fromView) and @org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(toView)">
					and a.from_view <![CDATA[>]]> #{fromView} and a.to_view <![CDATA[<=]]> #{toView}
				</when>
				<when test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(fromView)">
					and a.from_view <![CDATA[>]]> #{fromView}
				</when>
				<when test="@org.jwebppy.platform.core.util.CmMyBatisQueryUtils@isNotEmpty(toView)">
					and a.to_view <![CDATA[<=]]> #{toView}
				</when>
			</choose>
	
			order by a.p_seq desc, a.sort, a.depth
		) z

	</select>	
</mapper>