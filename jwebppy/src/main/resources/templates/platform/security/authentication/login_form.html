<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<title th:text="#{PLTF_T_0006}"></title>

<link rel="stylesheet" type="text/css" th:href="@{/platform/css/login/login.css}" />

<script type="application/javascript" th:src="@{/platform/js/jquery/jquery.min.js}"></script>
<script type="application/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="application/javascript" th:src="@{/platform/js/jWebppy.utils.object.js}"></script>
<script type="application/javascript" th:src="@{/platform/js/jWebppy.utils.string.js}"></script>
<script type="application/javascript" th:src="@{/platform/js/jquery/jquery.cookie.js}"></script>
<script type="application/javascript">
$(window).load(function() {
	showLoginBox();
});

$(window).resize(function() {
	resizeView();	
});

/*
 * HD: 1280X720
 * FDH: 1920X1080
 */
let RESIZING_MIN_WIDTH = 1700;

function resizeView()
{
	//let width = $(window).width();
	//let height = $(window).height();
	
	/*
	if (width > RESIZING_MIN_WIDTH)
	{
		$("#IMG_main").width(width*0.97);
	}
	else
	{
		$("#IMG_main").width(RESIZING_MIN_WIDTH*0.97);
	}
	*/
	
	$("#IMG_main").width($(window).width() * 0.9);
	$("#IMG_main").height($(window).height() * 0.9);
};

function loginCheck()
{
	if ($.trim($("#username").val()) == "")
	{
		alert("[[#{PLTF_M_LOGIN_EMPTY_USERNAME}]]");
		$("#username").focus();
		return false;
	}
	else if ($.trim($("#password").val()) == "")
	{
		alert("[[#{PLTF_M_LOGIN_EMPTY_PWD}]]");
		$("#password").focus();			
		return false;				
	};
	
	return true;
};

function loginStep1()
{
	let key = "[[${key}]]";
	let token = "[[${token}]]";
	
	if (JpUtilsString.isEmpty(key) && JpUtilsString.isEmpty(token))
	{
		loginStep2();
	}
	else
	{
		$.ajax({
			contentType:"application/json",         
			type: "GET", //GET, POST
			url: "https://gateway.apig.d-platform.doosan.com/authform/sso/inbound/ad",
			headers: { "user-key": key, "user-token": token, "user-xuser": $("#username").val(), "user-xpass": $("#password").val() },
			beforeSend: function(jqXHR, settings)
			{
				//ProgressBar.show();
			},
			success: function(response, textStatus, jqXHR)
			{
				if (response != null)
				{
					let result = response.RESULT;
					
					console.log(response);
					$("#token").val(result);
				};
			},
			error: function(jqXHR, textStatus, errorThrown)
			{
				console.log("AD authorization failed. Start to login using this system.");
			},
			complete: function(jqXHR, textStatus)
			{
				loginStep2();
			}
		});		
	};
};

function loginStep2()
{
	$.ajax({
		type: "POST", //GET, POST
		url: "/platform/security/authentication/check",
		data: $("#FORM_login").serialize(),
		success: function(data, textStatus, jqXHR)
		{
			$.cookie("username", $("#username").val(), { expires : 365 });
			document.location.href = "/forward/entry_point";
		},			
		error: function(jqXHR, textStatus, errorThrown)
		{
			let status = jqXHR.status;

			if (status == "401")
			{
				alert("[[#{PLTF_M_LOGIN_AUTHENTICATION_FAILED}]]");
			}
			else if (status == "403")
			{
				alert("[[#{PLTF_M_LOGIN_HAVE_NO_AUTHORITY}]]");
			}
			else if (status == "423")
			{
				alert("[[#{PLTF_M_LOGIN_ACCOUNT_LOCKED}]]");
			};
		},
		complete: function(jqXHR, textStatus)
		{
			//ProgressBar.hide();
		}
	});
};

$(document).ready(function() {
	if ($.trim($.cookie("username")) != "")
	{
		$("#username").val($.cookie("username"));
	};	
	
	$(".btn-login").on("click", function() {
		if (loginCheck())
		{
			loginStep1();
		};	
	});

	$("#username, #password").on("focus", function(event) {
		this.select();
	});	
	
	$("#username, #password").on("keydown", function(event) {
		if (event.keyCode == 13)
		{
			if (loginCheck())
			{
				loginStep1();
			}
		}
	});
	
	$("#openNewWindow").on("click", function() {
		window.open("/", new Date().getMilliseconds());
	});
	
	$(".save-username").on("click", function() {
		let src = "/platform/img/login/uncheck.png";		
		
		if ($(this).find("img").attr("src").indexOf("uncheck") > -1)
		{
			src = "/platform/img/login/check.png";
			$("#saveUsername").val("Y");
		}
		else
		{
			$("#saveUsername").val("N");
		};
		
		$(this).find("img").attr("src", src);
	});
	
	resizeView();
});

function showLoginBox()
{
	$(".login-box").toggle("drop", 300);
};
</script>
</head>
<body>
<div style="position: fixed; cursor: pointer;" onclick="showLoginBox()">
	<img th:src="@{/platform/img/login/idea_100.jpg}" alt="Login Button" />
</div>
<div id="openNewWindow" style="position: fixed; top: 5px; right: 5px; cursor: pointer; font-weight: bold;">New Window</div>
<form id="FORM_login" method="post" onsubmit="return loginCheck();">
<input type="hidden" id="token" name="token" />
<input type="hidden" id="saveUsername" name="saveUsername" />
<div id="wrap" class="wrap">
	<div style="text-align: center">
	<img id="IMG_main" th:src="@{/platform/img/login/main.jpg}" alt="Main Image" />
	</div> 
	<div class="body">
		<div class="login-box" style="display:none;">
			<div class="title" th:text="#{PLTF_T_LOGIN_BOX_HEADER}"></div>
			<div class="username"><img th:src="@{/platform/img/login/username.png}" class="login-input" alt="Username" /><input type="text" id="username" name="username" th:placeholder="#{PLTF_L_USERNAME}" /></div>
			<div class="password"><img th:src="@{/platform/img/login/password.png}" class="login-input" alt="Password" /><input type="password" id="password" name="password" th:placeholder="#{PLTF_L_PASSWORD}" /></div>
			<button class="btn-login" type="button" th:text="#{PLTF_B_LOGIN}"></button>
			<div class="bottom"> 
				<div class="save-username"><img th:src="@{/platform/img/login/check.png}" class="save-username-chk" alt="Save Username" /><span>[[#{PLTF_L_SAVE-USERNAME}]]</span></div>
			</div>
		</div>
	</div>
	<div class="bottom" style="height: 80px;">
		<div class="copy-right">
			<div class="text"th:text="#{PLTF_T_COPYLEFT}"></div>
		</div>
	</div>
</div>
</form>
</body>
</html>