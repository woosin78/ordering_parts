<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<title th:text="#{PLTF_TXT_0006}"></title>

<link rel="stylesheet" type="text/css" th:href="@{/platform/css/login/login.css}" />

<script type="application/javascript" th:src="@{/platform/js/jquery/jquery.min.js}"></script>
<script type="application/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="application/javascript" th:src="@{/platform/js/jWebppy.utils.object.js}"></script>
<script type="application/javascript" th:src="@{/platform/js/jWebppy.utils.string.js}"></script>
<script type="application/javascript" th:src="@{/platform/js/jquery/jquery.cookie.js}"></script>
<script type="application/javascript">
$(window).resize(function() {
	resizeView();
});

$(window).load(function() {
	resizeView();
});

let RESIZING_MIN_WIDTH = 1500;
let VIEW_MARGIN_WIDTH = 80;

function resizeView()
{
	let width = $(window).width();
	
	if (width > RESIZING_MIN_WIDTH)
	{
		$("#mainImg, #header, #bottom").width(width - VIEW_MARGIN_WIDTH);
	}
	else
	{
		$("#mainImg, #header, #bottom").width(RESIZING_MIN_WIDTH - VIEW_MARGIN_WIDTH);
	}
};

function loginFormCheck()
{
	if ($.trim($("#username").val()) == "")
	{
		alert("[[#{PLTF_MSG_0005}]]");
		$("#username").focus();
		return false;
	}
	else if ($.trim($("#password").val()) == "")
	{
		alert("[[#{PLTF_MSG_0006}]]");
		$("#password").focus();			
		return false;				
	};
	
	return true;
};

function loginStep1()
{
	let key = "[[${key}]]";
	let token = "[[${token}]]";
	
	if (JpUtilsString.isEmpty(key) && JpUtilsString.isEmpty(token))
	{
		loginStep2();
	}
	else
	{
		$.ajax({
			contentType:"application/json",         
			type: "GET", //GET, POST
			url: "https://gateway.apig.d-platform.doosan.com/authform/sso/inbound/ad",
			headers: { "user-key": key, "user-token": token, "user-xuser": $("#username").val(), "user-xpass": $("#password").val() },
			beforeSend: function(jqXHR, settings)
			{
				//ProgressBar.show();
			},
			success: function(response, textStatus, jqXHR)
			{
				if (response != null)
				{
					let result = response.RESULT;
					
					console.log(response);
					$("#token").val(result);
				};
			},
			error: function(jqXHR, textStatus, errorThrown)
			{
				console.log("AD authorization failed. Start to login using this system.");
			},
			complete: function(jqXHR, textStatus)
			{
				loginStep2();
			}
		});		
	};
};

function loginStep2()
{
	$.ajax({
		type: "POST", //GET, POST
		url: "/platform/security/authentication/check",
		data: $("#loginForm").serialize(),
		success: function(data, textStatus, jqXHR)
		{
			$.cookie("username", $("#username").val(), { expires : 365 });
			document.location.href = "/forward/entry_point";
		},			
		error: function(jqXHR, textStatus, errorThrown)
		{
			let status = jqXHR.status;

			if (status == "401")
			{
				alert("[[#{PLTF_MSG_0004}]]");
			}
			else if (status == "403")
			{
				alert("[[#{PLTF_MSG_0050}]]");
			}
			else if (status == "423")
			{
				alert("[[#{PLTF_MSG_ACCOUNT_LOCKED}]]");
			};
		},
		complete: function(jqXHR, textStatus)
		{
			//ProgressBar.hide();
		}
	});
};

$(document).ready(function() {
	if ($.trim($.cookie("username")) != "")
	{
		$("#username").val($.cookie("username"));
		$("#password").focus();
	};	
	
	$(".btn-login").on("click", function() {
		if (loginFormCheck())
		{
			loginStep1();
		};	
	});

	$("#username, #password").on("focus", function(event) {
		this.select();
	});	
	
	$("#username, #password").on("keydown", function(event) {
		if (event.keyCode == 13)
		{
			if (loginFormCheck())
			{
				loginStep1();
			}
		}
	});
	
	$("#openNewWindow").on("click", function() {
		window.open("/", new Date().getMilliseconds());
	});
	
	$(".save-username").on("click", function() {
		let src = "/platform/img/login/uncheck.png";		
		
		if ($(this).find("img").attr("src").indexOf("uncheck") > -1)
		{
			src = "/platform/img/login/check.png";
			$("#saveUsername").val("Y");
		}
		else
		{
			$("#saveUsername").val("N");
		};
		
		$(this).find("img").attr("src", src);
	});
	
	$(".gdpr").on("click", function() {
		document.location.href = "/platform/img/login/Doosan_General_Data_Protection_Policy.docx";
	});
	
	$("#IMG_doobizPlus").on("click", function() {
		document.location.href = "/forward/entry_point";
	});	
});
</script>
</head>
<body>
<form id="loginForm" method="post" onsubmit="return loginFormCheck();">
<input type="hidden" id="token" name="token" />
<input type="hidden" id="saveUsername" name="saveUsername" />
<div id="wrap" class="wrap"> 
	<div id="header" class="header">
		<div id="openNewWindow" class="button">New Window</div>
	</div>
	<div id="body" class="body">
		<div><img id="mainImg" th:src="@{/platform/img/login/main.png}" alt="Main Image" /></div>
		<div class="login-box">
			<div class="title" th:text="#{PLTF_TXT_0007}"></div>
			<div class="username"><img th:src="@{/platform/img/login/username.png}" class="login-input" alt="Username" /><input type="text" id="username" name="username" th:placeholder="#{PLTF_TXT_0002}" autofocus /></div>
			<div class="password"><img th:src="@{/platform/img/login/password.png}" class="login-input" alt="Password" /><input type="password" id="password" name="password" th:placeholder="#{PLTF_TXT_0001}" /></div>
			<button class="btn-login" type="button" th:text="#{PLTF_BTN_0002}"></button>
			<div class="bottom"> 
				<div class="save-username"><img th:src="@{/platform/img/login/check.png}" class="save-username-chk" alt="Save Username" /><span>[[#{PLTF_TXT_0005}]]</span></div>
				<!-- div class="manual">
					<select class="select-box">
						<option>Manual Download</option>
						<option>Korean</option>
						<option>English</option>
					</select>				
				</div -->
			</div>
		</div>
	</div>
	<div id="bottom" class="bottom">
		<div class="personal-policy" style="float: left;">
This Site is for the use of authorized Doosan Group Personnel only and by accessing this site you hereby consent to the site being monitored.<br/>
Any unauthorized use will be considered a breach of Doosan Group Information Security Policies and may also be in violation of laws.<br/>
본 사이트는 두산 임직원 및 인가된 사용자만 사용할 수 있으며, 사용자 접속 모니터링 및 로그를 기록하고 있습니다. 불법 사용시에는 법령에 의해 민∙형사상 책임을 질 수 있습니다.
		</div>
		<div style="height:52px;"></div>
		<div class="line"></div>
		<div class="copy-right">
			<span class=".text">[[#{PLTF_TXT_0008}]]</span>
		</div>
	</div>
</div>
</form>
</body>
</html>