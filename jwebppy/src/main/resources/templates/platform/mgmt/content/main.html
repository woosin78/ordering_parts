<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{platform/layout/common/index}">

<th:block layout:fragment="content">
<!-- body start -->
<div class="ui dividing header">
  Content
  <div class="sub header">You can create Page or consist of Menu and Role. The content is translated into other languages.</div>
</div>
<div class="ui segment">
	<div class="ui stackable grid">
		<div class="row">
			<div class="nine wide column">
				<div class="ui dividing small header">Structure</div>
				<div class="ui segment teal">
					<div id="TREE_items"></div>
				</div>
			</div>
			<div class="seven wide column">
				<div id="AREA_createItem" class="field">
					<div class="ui dividing small header">Attributes</div>
					<div id="TAB_viewItem" class="ui secondary pointing menu">
						<a class="item active wrap" data-tab="general">General</a>
						<a class="item wrap" data-tab="language">Language</a>
					</div>
					<div class="ui bottom attached segment">
						<form id="FORM_modifyItem" class="ui form">
						<input type="hidden" name="cSeq"/>
						<input type="hidden" name="pSeq"/>
							<div class="AREA_modifyItem" style="display: none;">
								<div class="ui teal button BTN_saveItem"><i class="check icon"></i> Save</div>
								<div class="ui button modify BTN_cancelItem"><i class="times icon"></i> Cancel</div>
								<div class="ui clearing divider"></div>									
							</div>
							<div class="AREA_moveToModifyItem" style="display: none;">
								<div class="ui teal button BTN_modifyItem"><i class="edit outline icon"></i> Modify</div>
								<div class="ui clearing divider"></div>
							</div>
							<div class="AREA_moveToViewLang" style="display: none;">
								<div class="ui teal button BTN_translation"><i class="globe icon"></i> Translation</div>
								<div class="ui clearing divider"></div>
							</div>
							<div class="ui segment tab teal" data-tab="general"></div>
							<div class="ui segment tab teal" data-tab="language"></div>
							<div class="AREA_modifyItem" style="display: none;">
								<div class="ui clearing divider"></div>
								<div class="ui teal button BTN_saveItem"><i class="check icon"></i> Save</div>
								<div class="ui button modify BTN_cancelItem"><i class="times icon"></i> Cancel</div>
							</div>
							<div class="AREA_moveToModifyItem" style="display: none;">
								<div class="ui clearing divider"></div>
								<div class="ui teal button BTN_modifyItem"><i class="edit outline icon"></i> Modify</div>
							</div>
							<div class="AREA_moveToViewLang" style="display: none;">
								<div class="ui clearing divider"></div>
								<div class="ui teal button BTN_translation"><i class="globe icon"></i> Translation</div>
							</div>								
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<form id="FORM_updateLang" method="post">
<input type="hidden" name="cSeq"/>
<input type="hidden" name="lSeq"/>
</form>
<!-- Start add language -->
<th:block th:replace="/platform/common/lang :: addLang"></th:block>
<!-- End add language -->
<script type="application/javascript">

	$(document).ready(function() {
	});
	
	let viewItemTab = new JpUiTab($("#TAB_viewItem"));
	
	viewItemTab.settings = {
			ajax: {
				beforeSend: function(settings)
				{
					settings.data = $("#FORM_modifyItem").serialize();					
					return settings;
				}
			},
			tab: {
				path: JpUiGlobal.url("/platform/mgmt/content"),
				form: $("#FORM_modifyItem"),
				onLoaded: function(tabPath, parameterArray, historyEvent)
				{
					if (tabPath == "general")
					{
						if (isOnForm())
						{
							JpUiCalendar.datetimeCalendar($("#fromValid"), $("#toValid"));
							
							$("#FORM_modifyItem select[name=component]").on("change", function() {
								JpUtilsAjax.get({
									url: JpUiGlobal.url("/platform/mgmt/content/component/entry_points?component=" + $(this).val()),
									global: false,
									success: function(data, textStatus, jqXHR)
									{
										let options = [];
										options.push("<option value=''></option>");
										
									    data.RESULT.forEach(function(element, index) {
									    	options.push("<option value='" + element.url + "' data-key='" + element.url + "'>" + element.url + "</option>");
									    });
									    
									    $("#FORM_modifyItem select[name=entryPoint]").html(options.join(""));
									}
								});								
							});
							
							//Add custom rules in the form validation
							$.fn.form.settings.rules.checkDuplicatedName = function(value)
							{
								if (JpUtilsString.isNotEmpty(value))
								{
									let isValid = false;
									
									JpUtilsAjax.get({
										url: JpUiGlobal.url("/platform/mgmt/content/name/valid_check"),
										data: { name: value, cSeq: getSeq(), type: $("#FORM_modifyItem select[name=type]").val() },
										global: false,
										async: false,
										success: function(data, textStatus, jqXHR)
										{
											if (data.RESULT == "duplicated")
											{
												isValid = false;
											}
											else
											{
												isValid = true;
											};
										}
									});

									return isValid;
								};

								return false;
							};
							
							let formValidCheck = {
									inline: true,
									fields: {
										"Item Type": {
											identifier: "type",
											rules: [
												{
													type: "empty",
													prompt: "Please enter {name}."
												}
											]
										},
										Name: {
											identifier: "name",
											rules: [
												{
													type: "empty",
													prompt: "Please enter {name}."
												},
												{
													type: "checkDuplicatedName",
													prompt: "The {name} is not available. Please enter another name."
												}												
											]
										},
										"Valid From": {
											identifier: "fromValid",
											rules: [
												{
													type: "empty",
													prompt: "Please enter {name}."
												}
											]
										},
										"Valid To": {
											identifier: "toValid",
											rules: [
												{
													type: "empty",
													prompt: "Please enter {name}."
												}
											]
										},
										Sort: {
											identifier: "sort",
											rules: [
												{
													type: "empty",
													prompt: "Please enter {name}."
												},
												{
										            type   : "integer",
										            prompt : "Please enter a valid number."								
												}
											]
										}
									},
									keyboardShortcuts: false
								};
							
							$("#FORM_modifyItem").form(formValidCheck);					
						};
					}
					else
					{
						$("#FORM_modifyItem select[name=basename]").on("change", function() {
							changeTab("language");
						});
					}
					
					changeButtonStatus();
					viewItemTab.changePath(JpUiGlobal.url("/platform/mgmt/content"));
				}
			}
	};
	
	let tree = new JpUiTree($("#TREE_items"));
	tree.icons = {FOLDER: "folder", FOLDER_OPEN: "folder open", PAGE: "file", MENU: "table", ROLE: "user"};
	tree.onLoad = function()
	{
		if (JpUtilsString.isEmpty(getSeq()))
		{
			let root = tree.getRoot();
			setSeq(root.KEY, root.P_KEY);
			
			viewItemTab.render();
		};
	};
	tree.viewDetail = function(key, pKey, target)
	{
		$(".ui.tab[data-tab=general], .ui.tab[data-tab=language]").empty();
		
		setSeq(key, pKey);
		viewItemTab.changeTab("general");
	};
	tree.createItem = function(key, pKey)
	{
		initSeq();
	
		$("#FORM_modifyItem input[name='pSeq']").val(key);
	
		viewItemTab.changePath(JpUiGlobal.url("/platform/mgmt/content/modify"));
		changeTab();
	};
	tree.deleteItem = function(key, pKey)
	{
		if (confirm("Do you want to delete the item?"))
		{
			setSeq(key, pKey);
			
			JpUtilsAjax.post({
				url: JpUiGlobal.url("/platform/mgmt/content/delete"),
				data: $("#FORM_modifyItem").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					initSeq();
					
					tree.refresh();
					changeTab();
				}
			});
		};
	};
	tree.pasteItem = function(key, pKey)
	{
		let previousCommand = tree.getPreviousCommand();
		let url;
		
		for (let i=0, length=tree.commands.length; i<length; i++)
		{
			console.log(tree.commands[i]);	
		};
		
		if (previousCommand.COMMAND == "COPY")
		{
			url = "/platform/mgmt/content/copy";
			
			if (tree.isSubItems())
			{
				if (confirm("Do you want to copy including the sub items?"))
				{
					url = "/platform/mgmt/content/copy_with_sub_items";	
				};
					
			};
		}
		else if (previousCommand.COMMAND == "CUT")
		{
			url = "/platform/mgmt/content/move";
		};
		
		if (JpUtilsString.isNotEmpty(url))
		{
			let command = tree.getCommand();
			
			setSeq(previousCommand.KEY, key);
			
			JpUtilsAjax.post({
				url: JpUiGlobal.url(url),
				data: $("#FORM_modifyItem").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					initSeq();
					
					tree.refresh();
					changeTab();
				}
			});
		};
	};	
	tree.setUrl("/platform/mgmt/content/tree");
	tree.render();
	
	$(".BTN_modifyItem").on("click", function() {
		viewItemTab.changePath(JpUiGlobal.url("/platform/mgmt/content/modify"));
		changeTab();
	});
	
	$(".BTN_saveItem").on("click", function() {
		if ($("#FORM_modifyItem").form("validate form"))
		{
			JpUtilsAjax.post({
				url: JpUiGlobal.url("/platform/mgmt/content/save/" + viewItemTab.tabPath),
				data: $("#FORM_modifyItem").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					if (JpUtilsString.isEmpty(getSeq()))
					{
						if (JpUtilsObject.isNotNull(data.RESULT))
						{
							setSeq(data.RESULT, getPSeq());
						};
					}					
					
					changeTab();
					tree.refresh();
					
					//refresg gmb. There is the function in top.html.
					makeGmb();
				}
			});
		};
	});
	
	function setSeq(seq, pSeq)
	{
		$("#FORM_modifyItem input[name=cSeq]").val(JpUtilsString.trimToEmpty(seq));
		$("#FORM_modifyItem input[name=pSeq]").val(JpUtilsString.trimToEmpty(pSeq));
	};
	
	function getSeq()
	{
		return $("#FORM_modifyItem input[name=cSeq]").val(); 
	};
	
	function getPSeq()
	{
		return $("#FORM_modifyItem input[name=pSeq]").val(); 
	};
	
	function initSeq()
	{
		$("#FORM_modifyItem input[name=cSeq], [name=pSeq]").val("");
	};	
	
	$(".BTN_cancelItem").on("click", function() {
		changeTab();
	});	
	
	function changeButtonStatus()
	{
		$(".AREA_moveToModifyItem, .AREA_modifyItem, .AREA_moveToViewLang").css("display", "none");
		
		if (viewItemTab.tabPath == "general")
		{
			if (!isRoot())
			{
				if (isOnForm())
				{
					$(".AREA_modifyItem").css("display", "block");
				}
				else
				{
					$(".AREA_moveToModifyItem").css("display", "block");
				};					
			};
		}
		else
		{
			$(".AREA_moveToViewLang").css("display", "block");
		};			
	};
	
	function changeTab(tabPath)
	{
		changeButtonStatus();
	
		viewItemTab.changeTab(tabPath);
	};
	
	function isCreating()
	{
		if (isOnForm() && getSeq() == "")
		{
			return true;
		}
	
		return false;
	};
	
	function isOnForm()
	{
		return (viewItemTab.getPath().indexOf("modify") > -1) ? true : false;
	};	
	
	function isRoot()
	{
		if (getPSeq() == "")
		{
			return true;
		};
		
		return false;
	};
	
	$(".BTN_translation").on("click", function() {
		JpUtilsAjax.get({
			url: JpUiGlobal.url("/platform/mgmt/content/lang"),
			data: $("#FORM_modifyItem").serialize(),
			global: false,
			success: function(data, textStatus, jqXHR)
			{
				if (data.RESULT != null)
				{
					viewLang("CONTENT", data.RESULT.lseq, data.RESULT.messageCode, data.RESULT.basename);
				}
				else
				{
					viewLang("CONTENT");
				};
			}
		});
	});
	
	function doAfterSavingLang(lSeq)
	{
		$("#FORM_updateLang input[name=cSeq]").val(getSeq());
		$("#FORM_updateLang input[name=lSeq]").val(lSeq);
		
		JpUtilsAjax.post({
			url: JpUiGlobal.url("/platform/mgmt/content/lang/save"),
			data: $("#FORM_updateLang").serialize(),
			success: function(data, textStatus, jqXHR)
			{
				changeTab("language");
				tree.refresh();
			}
		});
	};
	
	function doAfterDeletingLang()
	{
		changeTab("language");
		tree.refresh();
	};
</script>

</th:block>
</html>