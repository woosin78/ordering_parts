<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{platform/layout/common/index}">

<th:block layout:fragment="content">
<div class="ui dividing header">
  Account
  <div class="sub header">You can create new accounts and modify users' information and give them the authorities.</div>
</div>
<div class="ui segment">
	<form id="FORM_search" class="ui form" autocomplete="off" onsubmit="return false;">
	<input type="checkbox" name="uSeq" style="display:none" value="" checked />
	<input type="hidden" id="pageNumber" name="pageNumber"  th:value="${pageNumber}"/>
	<input type="hidden" id="rowPerPage" name="rowPerPage"  th:value="${rowPerPage}"/>	
	<div class="fields">
		<div class="twelve wide field">
			<div class="ui icon input">
				<input type="text" id="query" name="query" placeholder="Search"> <i class="search icon"></i>
			</div>
		</div>
		<div class="four wide field">
			<div id="BTN_searchUser" class="ui teal button"><i class="search icon"></i> Search</div>
			<div class="ui button" onclick="document.location.reload()"><i class="redo icon"></i> Reset</div>
		</div>
	</div>
	<div class="ui divider"></div>
	<div class="ui one column grid">
		<div class="column">
			<div id="BTN_createUser" class="ui teal button"><i class="plus icon"></i> Create</div>
			<div id="BTN_copyToCreateUser" class="ui teal button"><i class="copy outline icon"></i> Copy To Create</div>
			<div id="BTN_deleteUser" class="ui teal button"><i class="minus icon"></i> Delete</div>
			<div id="BTN_lockUser" class="ui teal button"><i class="lock icon"></i> Lock</div>
			<div id="BTN_unlockUser" class="ui teal button"><i class="lock open icon"></i> Unlock</div>
		</div>
	</div>
	<div id="TBL_users"></div>
	</form>
	<div class="ui segment" id="AREA_viewUserDetail">
		<div class="ui header"></div>
		<div class="ui clearing divider"></div>
		<div id="TAB_viewUserDetail" class="ui secondary pointing menu">
			<a class="item active wrap" data-tab="general">General</a>
			<a class="item wrap" data-tab="account">Account</a>
			<a class="item wrap" data-tab="contact">Contact</a>
			<a class="item wrap" data-tab="authority">Authority</a>
			<a class="item wrap" data-tab="login_history">Login History</a>
		</div>
		<div class="AREA_moveToModifyUser">
			<div class="ui teal button BTN_modifyUser"><i class="edit outline icon"></i> Modify</div>
			<div class="ui clearing divider"></div>
		</div>
		<div class="AREA_modifyUser" style="display:none;">
			<div class="ui teal button modify BTN_saveUser"><i class="check icon"></i> Save</div>
			<div class="ui button modify BTN_cancelUser"><i class="times icon"></i> Cancel</div>
			<div class="ui clearing divider"></div>
		</div>
		<form id="FORM_modifyUser" class="ui form" autocomplete="off" onsubmit="return false;">
			<input type="hidden" name="uSeq" />
			<div class="ui tab active attached segment teal" data-tab="general"></div>
			<div class="ui tab attached segment teal" data-tab="account"></div>
			<div class="ui tab attached segment teal" data-tab="contact"></div>
			<div class="ui tab attached segment teal" data-tab="authority"></div>
			<div class="ui tab attached" data-tab="login_history"></div>
		</form>
		<div class="AREA_moveToModifyUser">
			<div class="ui clearing divider"></div>
			<div class="ui teal button BTN_modifyUser"><i class="edit outline icon"></i> Modify</div>
		</div>
		<div class="AREA_modifyUser" style="display:none;">
			<div class="ui clearing divider"></div>
			<div class="ui teal button modify BTN_saveUser"><i class="check icon"></i> Save</div>
			<div class="ui button modify BTN_cancelUser"> Cancel</div>
		</div>
	</div>
	
	<div id="MDL_coptyToCreate" class="ui tiny modal">
	    <h3 class="ui header">Create User</h3>
	    <div class="content">
	    	<form id="FORM_copyToCreate" method="POST" class="ui form" autocomplete="off">
	    	<input type="hidden" name="uSeq"/>
	    	<div class="ui one column grid">
	    		<div class="column">
	    			<div class="field required">
	    				<label>Username</label>
	    				<input type="text" name="username" style="text-transform: uppercase;"/>
	    			</div>
	    			<div class="field required">
	    				<label>Password</label>
	    				<input type="password" name="password"/>
	    			</div>
	    			<div class="field required">
	    				<label>Last Name</label>
	    				<input type="text" name="lastName"/>
	    			</div>
	    			<div class="field">
	    				<label>First Name</label>
	    				<input type="text" name="firstName"/>
	    			</div>
	    		</div>
	    	</div>
	    	</form>
	    </div>
	    <div class="ui divider"></div>
	    <div class="footer">
			<div class="ui one column grid">
			    <div class="column right aligned">
			    	<div id="BTN_saveUserByCopy" class="ui teal button"><i class="check icon"></i> Save</div>
			        <div id="BTN_cancelUserByCopy" class="ui normal button"><i class="times icon"></i> Cancel</div>
			    </div>
			</div>
	    </div>
	    <div class="ui hidden divider"></div>
	</div>
</div>
<script th:inline="javascript">
$(document).ready(function() {
	let usersTable = new JpUiTable($("#TBL_users"));
	usersTable.settings = {
			ajax: {
				url: JpUtilsPath.url("/platform/mgmt/user/list/data"),
				form: $("#FORM_search"),
				async: false,
		  		beforeSend: function(jqXHR, settings)
		  		{
		  			hideUserDetailsArea();
		  		},
		  		complete: function(jqXHR, textStatus)
				{
		  			if (textStatus == "success")
	  				{
		  				if (JpUtilsString.isNotEmpty(getSeq()))
		  				{
			  				usersTable.getBodyCell(0, 3).find("a").trigger("click");
		  				};
	  				};
				}
			},
			onClickDataKey: function(element, key, row)
			{
				viewUserTab.changePath(JpUtilsPath.url("/platform/mgmt/user/detail"));

				if ($(row).hasClass("active"))
				{
					$("#AREA_viewUserDetail .ui.header").html("Details of User, " + $(element).html());

					setSeq(key);
					showUserDetailsArea();
				}
				else
				{
					initSeq();
					hideUserDetailsArea();
				};
			},
			editColumns: function(trIndex, tr, tdIndex, td, text)
			{
				if (tdIndex == 1)
				{
					if (text == "Y")
					{
						return "<i class='lock icon'></i>";
					}
					else 
					{
						return "<i class='lock open icon'></i>";
					};
				};
			},
			onClickPageNumber: function(pageNumber)
			{
				doSearch(pageNumber);
			}
	};

	//Add custom rules in the form validation
	let checkUsernameResultMsg = "";
	let checkPasswordResultMsg = "";
	
	$.fn.form.settings.rules.checkCredentialPolicy = function(value, type)
	{
		let isValid = false;
		
		if (JpUtilsString.isNotEmpty(value))
		{
			JpUtilsAjax.get({
				url: JpUtilsPath.url("/platform/mgmt/user/credentials/valid_check"),
				data: { value: value, type: type, cpSeq: $("#FORM_modifyUser select[name=cpSeq]").val() },
				global: false,
				async: false,
				success: function(data, textStatus, jqXHR)
				{
					let result = data.RESULT;
					
					if (result.RESULT == 1)
					{
						isValid = true;
					};
					
					let message = "";
					
					$.each(data.RESULT.MESSAGE, function (index, value) {
						message += value + "<br/>";
					});
					
					if (type == "U")
					{
						checkUsernameResultMsg = message;
					}
					else
					{
						checkPasswordResultMsg = message;
					};
				}
			});
		};

		return isValid;
	};

	let formValidCheck = {
		inline: true,
		fields: {
			"Last Name": {
				identifier: "lastName",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					}
				]
			},
			Language: {
				identifier: "language",
				rules: [
					{
						type: "empty",
						prompt: "Please select {name}."
					}
				]
			},
			"User Group": {
				identifier: "ugSeq",
				rules: [
					{
						type: "empty",
						prompt: "Please select {name}."
					}
				]
			},			
			Username: {
				identifier: "username",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					},
					{
						type: "checkCredentialPolicy[U]",
						prompt: function (value)
						{
							return checkUsernameResultMsg;
						}
					}
				]
			},
			Password: {
				identifier: "password",
				optional: true,
				rules: [
					{
						type: "checkCredentialPolicy[P]",
						prompt: function (value)
						{
							return checkPasswordResultMsg;
						}
					}
				]
			},
			"Confirm Password": {
				identifier: "confirmPassword",
				rules: [
					{
						type: "match[password]",
						prompt: "Please check {name}. They doesn't match."
					}
				]
			},
			Email: {
				identifier: "email",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					},
					{
						type: "email",
						prompt: "Please enter a valid {name}."
					}
				]
			},
			tel1: {
				identifier: "tel1",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			tel2: {
				identifier: "tel2",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			tel3: {
				identifier: "tel3",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			mobile1: {
				identifier: "mobile1",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			mobile2: {
				identifier: "mobile2",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			mobile3: {
				identifier: "mobile3",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			fax1: {
				identifier: "fax1",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			fax2: {
				identifier: "fax2",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			fax3: {
				identifier: "fax3",
				optional: true,
				rules: [
					{
						type: "number",
						prompt: "Please enter a valid number."
					}
				]
			},
			Country: {
				identifier: "country",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					}
				]
			},
			Timezone: {
				identifier: "timezone",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					}
				]
			}
		},
		keyboardShortcuts: false
	};

	let viewUserTab = new JpUiTab($("#TAB_viewUserDetail"));
	viewUserTab.settings = {
			ajax: {
				beforeSend: function(settings)
				{
					if (viewUserTab.tabPath != "general" && JpUtilsString.isEmpty(getSeq()))
					{
						alert("Please register the general information in advance.");
						showCreateUserArea();

						return false;
					};

					settings.data = $("#FORM_search").serialize();

					return settings;
				}
			},
			tab: {
				path: JpUtilsPath.url("/platform/mgmt/user/detail"),
				alwaysRefresh: true,
				onLoaded: function(tabPath, parameterArray, historyEvent)
				{
					if (isOnForm())
					{
						$("#FORM_modifyUser").form(formValidCheck);

						if (tabPath == "account")
						{
							JpUiCalendar.datetimeCalendar($("#fromValid"), $("#toValid"));
						}
						else if (tabPath == "contact")
						{
							$("#country").closest(".ui.dropdown").dropdown({
								onChange: function(value, text, $choice)
								{
									JpUtilsAjax.get({
										url: JpUtilsPath.url("/platform/mgmt/user/timezone"),
										data: {"country": value},
										global: false,
										success: function(data, textStatus, jqXHR)
										{
											$("#timezone").closest(".ui.dropdown").dropdown("change values", data.RESULT).dropdown("set text", "");
										}
									});
								}
							});
						}
						else if (tabPath == "authority")
						{
							let html = [];
							html.push("<div class='field'>");
							html.push("<label>Available Authority</label>");
							html.push("<select id='availableAutority' name='availableAutority' class='ui fluid search dropdown' multiple=''></select>");
							html.push("</div>");
							html.push("<div>");
							html.push("<div class='ui teal button BTN_grant'> Grant</div>");
							html.push("<div class='ui button BTN_revoke'> Revoke</div>");
							html.push("</div>");
							html.push("<p/>");
							html.push("<div id='TBL_myAuthorityList'></div>");

							$(".ui.tab[data-tab=authority]").html(html.join(""));

							JpUtilsAjax.get({
								url: JpUtilsPath.url("/platform/mgmt/content/contents"),
								data: {"type" : "R", "type" : "G"},
								global: false,
								success: function(data, textStatus, jqXHR)
								{
									if (data.RESULT != null)
									{
										let options = [];

									    data.RESULT.forEach(function(element, index) {
									    	options.push("<option value='" + element.cseq + "' data-key='" + element.cseq + "'>" + element.description + " - " + element.name + "</option>");
									    });

									    $("#availableAutority").html(options.join(""));

										$("#availableAutority").dropdown({
											minCharacters: 2,
											placeholder: "Search",
											fullTextSearch: true
										});

										$(".ui.tab[data-tab=authority] .ui.dropdown input.search").on("keydown", function(event) {
											if (event.keyCode == 13)
											{
												if ($(".ui.tab[data-tab=authority] .ui.dropdown a.ui.label.transition.visible").length > 0)
												{
													$(".BTN_grant").trigger("click");
												};
											};
										});
									};
								}
							});

							let myAuthorityTable = new JpUiTable($("#TBL_myAuthorityList"));
							myAuthorityTable.settings = {
									ajax: {
										url: JpUtilsPath.url("/platform/mgmt/user/my_authority"),
										global: false,
										form: $("#FORM_modifyUser")
									}
							};
							myAuthorityTable.render();

							$(".BTN_grant").on("click", function() {
								let values = $("#availableAutority").dropdown("get value");

								if (values == null)
								{
									values = [];
								};

								$.each($("#TBL_myAuthorityList").find("input:checkbox[name=cSeq]"), function(i, item) {
									values.push($(this).val());
								});

								myAuthorityTable.settings.ajax.data = "cSeqs=" + values.join(",");
								myAuthorityTable.render();

								$("#availableAutority").dropdown("clear");
								resetCheckAll();
							});

							$(".BTN_revoke").on("click", function() {
								myAuthorityTable.remove();
								resetCheckAll();
							});

							function resetCheckAll()
							{
								$("#TBL_myAuthorityList").find("thead .ui.checkbox").checkbox("uncheck");
							};
						};
					}

					changeButtonStatus();
					viewUserTab.changePath(JpUtilsPath.url("/platform/mgmt/user/detail"));
				}
			}
	};

	viewUserTab.render();

	$("#BTN_createUser").on("click", function() {
		showCreateUserArea();
	});

	$("#BTN_copyToCreateUser").on("click", function() {

		let checkedCount = getCheckedUserCount();

		if (checkedCount == 0)
		{
			alert("Please select the target to copy.");
			return;
		};

		if (checkedCount > 1)
		{
			alert("Please select one.");
			return;
		};

		$("#FORM_copyToCreate").form("reset");

		$("#MDL_coptyToCreate")
		.modal("setting", "closable", false)
		.modal("show");
	});

	$("#FORM_copyToCreate").form({
		inline: true,
		fields: {
			Username: {
				identifier: "username",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					},
					{
						type: "checkCredentialPolicy[U]",
						prompt: function (value)
						{
							return checkUsernameResultMsg;
						}						
					}					
				]
			},
			Password: {
				identifier: "password",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					},
					{
						type: "checkCredentialPolicy[P]",
						prompt: function (value)
						{
							return checkPasswordResultMsg;
						}						
					}					
				]
			},
			"Last Name": {
				identifier: "lastName",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					}
				]
			},
		}
	});

	$("#BTN_saveUserByCopy").on("click", function() {
		if ($("#FORM_copyToCreate").form("validate form"))
		{
			$("#FORM_copyToCreate input[name=uSeq]").val(usersTable.getCheckedValues().join(""));

			JpUtilsAjax.post({
				url: JpUtilsPath.url("/platform/mgmt/user/copy"),
				data: $("#FORM_copyToCreate").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					let uSeq = data.RESULT;
					
					if (JpUtilsObject.isNotNull(uSeq))
					{
						//신규 생성한 계정이 조회되도록 함
						$("#FORM_search")[0].reset();
						setSeq(uSeq);

						doSearch();
					};

					changeTab();

					$("#FORM_copyToCreate").form("reset");
				},
				complete: function(jqXHR, textStatus)
				{
					$("#MDL_coptyToCreate").modal("hide");
				}
			});
		};
	});

	$("#BTN_cancelUserByCopy").on("click", function() {
		$("#MDL_coptyToCreate").modal("hide");
	});

	$(".BTN_modifyUser").on("click", function() {
		viewUserTab.changePath(JpUtilsPath.url("/platform/mgmt/user/write"));

		changeTab();
	});

	$("#BTN_lockUser").on("click", function() {
		if (getCheckedUserCount() == 0)
		{
			alert("Please choose the users to lock.");
			return;
		};

		if (confirm("Do you want to lock the users?"))
		{
			JpUtilsAjax.post({
				url: JpUtilsPath.url("/platform/mgmt/user/lock"),
				data: $("#FORM_search").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					doSearch();
				}
			});
		};
	});

	$("#BTN_unlockUser").on("click", function() {
		if (getCheckedUserCount() == 0)
		{
			alert("Please choose the users to unlock.");
			return;
		};

		if (confirm("Do you want to unlock the users?"))
		{
			JpUtilsAjax.post({
				url: JpUtilsPath.url("/platform/mgmt/user/unlock"),
				data: $("#FORM_search").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					doSearch();
				}
			});
		};
	});

	$("#BTN_deleteUser").on("click", function() {
		if (getCheckedUserCount() == 0)
		{
			alert("Please choose the users to delete.");
			return;
		};

		if (confirm("Do you want to delete the users?"))
		{
			JpUtilsAjax.post({
				url: JpUtilsPath.url("/platform/mgmt/user/delete"),
				data: $("#FORM_search").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					doSearch();
				}
			});
		};
	});

	function setSeq(seq)
	{
		$("#FORM_search input:checkbox[name=uSeq]:first, #FORM_modifyUser input[name=uSeq]").val(seq);
	};

	function getSeq()
	{
		return JpUtilsString.trimToEmpty($("#FORM_modifyUser input[name=uSeq]").val());
	};

	function initSeq()
	{
		$("#FORM_search input:checkbox[name=uSeq]:first, #FORM_modifyUser input[name=uSeq]").val("");
	};

	function getCheckedUserCount()
	{
		return usersTable.getCheckedCount();
	};

	function doSearch(pageNumber)
	{
		$("#FORM_search input:hidden[name=pageNumber]").val(JpUtilsString.defaultString(pageNumber, "1"));
		$("#FORM_search input:hidden[name=rowPerPage]").val("10");

		usersTable.load();
	};

	function hideUserDetailsArea()
	{
		$("#AREA_viewUserDetail").hide();
	};

	function showUserDetailsArea()
	{
		changeTab("general");

		$("#AREA_viewUserDetail").show();
	};

	function showCreateUserArea()
	{
		$("#AREA_viewUserDetail .ui.header").html("Create User");

		initSeq();

		viewUserTab.changePath(JpUtilsPath.url("/platform/mgmt/user/write"));
		changeTab("general");

		$("#AREA_viewUserDetail").show();
	};

	$("#query").on("keydown", function(event) {
		if (event.keyCode==13)
		{
			doSearch();
		}
	}).on("click", function(event) {
		this.select();
	});

	$("#BTN_searchUser").on("click", function() {		
		setSeq("");
		doSearch();
	});

	$(".BTN_saveUser").on("click", function() {
		if ($("#FORM_modifyUser").form("validate form"))
		{
			if (viewUserTab.tabPath == "authority")
			{
				$("#TBL_myAuthorityList").find(".ui.checkbox").checkbox("check");
			};

			JpUtilsAjax.post({
				url: JpUtilsPath.url("/platform/mgmt/user/save/" + viewUserTab.tabPath),
				data: $("#FORM_modifyUser").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					if (JpUtilsString.isEmpty(getSeq()))
					{
						let uSeq = data.RESULT;

						if (JpUtilsObject.isNotNull(uSeq))
						{
							setSeq(uSeq);
						};
					};
					
					let tabPath = viewUserTab.tabPath;
					
					doSearch();
					changeTab(tabPath);
				}
			});
		}
	});

	$(".BTN_cancelUser").on("click", function() {
		if (JpUtilsString.isEmpty(getSeq()))
		{
			hideUserDetailsArea();
		}
		else
		{
			changeTab();
		};
	});

	function changeButtonStatus()
	{
		$(".AREA_moveToModifyUser, .AREA_modifyUser").css("display", "none");

		if (isOnForm())
		{
			$(".AREA_modifyUser").css("display", "block");
		}
		else
		{
			if (viewUserTab.tabPath != "login_history")
			{
				$(".AREA_moveToModifyUser").css("display", "block");
			}
		};
	};

	function changeTab(tabPath)
	{
		changeButtonStatus();

		viewUserTab.changeTab(tabPath);
	};

	function isCreating()
	{
		if (isOnForm() && JpUtilsString.isEmpty($("#FORM_modifyUser input[name=username]").val()))
		{
			return true;
		}

		return false;
	};

	function isOnForm()
	{
		return (viewUserTab.getPath().indexOf("write") > -1) ? true : false;
	};

	[# th:if="${uSeq != null}"]

	$("#FORM_search input[name=uSeq]").val([[${uSeq}]]);	

	[/]		
	
	doSearch();
});

</script>

</th:block>
</html>
