<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{platform/layout/common/index}">

<th:block layout:fragment="content">
<div class="ui dividing header">
  Authority
  <div class="sub header">You can create a new group or modify ones.</div>
</div>
<div class="ui segment">
	<form id="FORM_search" class="ui form" autocomplete="off" onsubmit="return false;">
	<input type="checkbox" name="cSeq" style="display:none" value="" checked />
	<input type="hidden" name="pageNumber" value="1"/>
	<input type="hidden" name="rowPerPage" value="10"/>
	<div class="fields">
		<div class="six wide field">
			<select name="type" class="ui search dropdown">
				<option value="">Type</option>
				<option value="G">GROUP</option>
				<option value="R">ROLE</option>
			</select>
		</div>
	</div>		
	<div class="fields">
		<div class="twelve wide field">
			<div class="ui icon input">
				<input type="text" id="query" name="query" placeholder="Search"> <i class="search icon"></i>
			</div>				
		</div>
		<div class="four wide field">
			<div id="BTN_searchUser" class="ui teal button"><i class="search icon"></i> Search</div>
			<div class="ui button" onclick="document.location.reload()"><i class="redo icon"></i> Reset</div>
		</div>
	</div>
	<div class="ui divider"></div>
	<div class="ui one column grid">
		<div class="column">
			<div id="BTN_createAuthority" class="ui teal button"><i class="plus icon"></i> Create</div>
			<div id="BTN_deleteAuthority" class="ui teal button"><i class="minus icon"></i> Delete</div>
		</div>
	</div>
	<div id="TBL_authority"></div>
	</form>
	<div class="ui segment" id="AREA_viewAuthorityDetail">
		<div class="ui header"></div>
		<div class="ui clearing divider"></div>
		<div id="TAB_viewAuthorityDetail" class="ui secondary pointing menu">
			<a class="item active wrap" data-tab="general">General</a>
			<a class="item wrap" data-tab="user">User</a>
			<a class="item wrap" data-tab="authority">Authority</a>
		</div>
		<div class="AREA_moveToModifyAuthority">
			<div class="ui teal button BTN_modifyAuthority"><i class="edit outline icon"></i> Modify</div>
			<div class="ui clearing divider"></div>
		</div>
		<div class="AREA_modifyAuthority" style="display:none;">
			<div class="ui teal button modify BTN_saveAuthority"><i class="check icon"></i> Save</div>
			<div class="ui button modify BTN_cancelAuthority"><i class="times icon"></i> Cancel</div>
			<div class="ui clearing divider"></div>
		</div>
		<form id="FORM_modifyAuthority" class="ui form" autocomplete="off" onsubmit="return false;">
			<input type="hidden" name="cSeq" />
			<div class="ui tab active attached segment teal" data-tab="general"></div>
			<div class="ui tab attached" data-tab="user"></div>
			<div class="ui tab attached segment teal" data-tab="authority"></div>
		</form>
		<div class="AREA_moveToModifyAuthority">
			<div class="ui clearing divider"></div>
			<div class="ui teal button BTN_modifyAuthority"><i class="edit outline icon"></i> Modify</div>				
		</div>			
		<div class="AREA_modifyAuthority" style="display:none;">
			<div class="ui clearing divider"></div>
			<div class="ui teal button modify BTN_saveAuthority"><i class="check icon"></i> Save</div>
			<div class="ui button modify BTN_cancelAuthority"> Cancel</div>				
		</div>			
	</div>
</div>
<script type="application/javascript">
$(document).ready(function() {
	let authorityTable = new JpUiTable($("#TBL_authority"));
	authorityTable.settings = {
			ajax: {
				url: JpUiGlobal.url("/platform/mgmt/authority/authorities"),
				async: false,
				form: $("#FORM_search"),
		  		beforeSend: function(jqXHR, settings)
		  		{
		  			hideUserDetailsArea();
		  		},
		  		complete: function(jqXHR, textStatus)
				{
		  			if (textStatus == "success")
	  				{
		  				if ($("#FORM_search input:hidden[name=cSeq]").val() != "")
		  				{
			  				authorityTable.getBodyCell(0, 3).find("a").trigger("click");
		  				};
	  				};
				}
			},
			onClickDataKey: function(element, key, row)
			{
				viewAuthorityTab.changePath(JpUiGlobal.url("/platform/mgmt/authority"));
				
				if ($(row).hasClass("active"))
				{
					$("#AREA_viewAuthorityDetail .ui.header").html("Details of Authority, " + $(element).html());
					
					setSeq(key);
					showUserDetailsArea();
				}
				else
				{
					initSeq();
					hideUserDetailsArea();
				};
			},
			onClickPageNumber: function(pageNumber)
			{
				doSearch(pageNumber);
			}
	};
	
	//Add custom rules in the form validation 
	$.fn.form.settings.rules.checkDuplicatedName = function(value)
	{
		if (JpUtilsString.isNotEmpty(value))
		{
			let isValid = true; 
			
			JpUtilsAjax.get({
				url: JpUiGlobal.url("/platform/mgmt/authority/name/valid_check"),
				data: { username: value },
				global: false,
				async: false,
				success: function(data, textStatus, jqXHR)
				{
					if (data.RESULT == "duplicated")
					{
						isValid = false;
					};
				}
			});
			
			return isValid;
		};
		
		return false;
	};
	
	let formValidCheck = {
		inline: true,
		fields: {
			Name: {
				identifier: "name",
				rules: [
					{
						type: "empty",
						prompt: "Please enter {name}."
					}
				]
			}
		},
		keyboardShortcuts: false
	};	
	
	let viewAuthorityTab = new JpUiTab($("#TAB_viewAuthorityDetail"));
	viewAuthorityTab.settings = {
			ajax: {
				beforeSend: function(settings)
				{
					if (viewAuthorityTab.tabPath != "general" && getSeq() == "")
					{
						alert("Please register the general information in advance.");
						showCreateAuthorityArea();

						return false;
					};
					
					settings.data = $("#FORM_search").serialize();
					
					return settings;
				}
			},
			tab: {
				path: JpUiGlobal.url("/platform/mgmt/authority"),
				alwaysRefresh: true,
				onLoaded: function(tabPath, parameterArray, historyEvent)
				{
					if (isOnForm())
					{
						$("#FORM_modifyAuthority").form(formValidCheck);
						
						if (tabPath == "general")
						{
							JpUiCalendar.calendar($("#fromValid"), JpUiCalendar.defaultCalendarSettings(false));
							JpUiCalendar.calendar($("#toValid"), JpUiCalendar.defaultCalendarSettings(false));
						}						
						else if (tabPath == "authority")
						{
							let html = [];
							html.push("<div class='field'>");
							html.push("<label>Available Role</label>");
							html.push("<select id='availableAutority' name='availableAutority' class='ui fluid search dropdown' multiple=''></select>");
							html.push("</div>");
							html.push("<div>");
							html.push("<div class='ui teal button BTN_add'> Add</div>");
							html.push("<div class='ui button BTN_remove'> Remove</div>");
							html.push("</div>");
							html.push("<p/>");
							html.push("<div id='TBL_myAuthorityList'></div>");

							$(".ui.tab[data-tab=authority]").html(html.join(""));

							JpUtilsAjax.get({
								url: JpUiGlobal.url("/platform/mgmt/content/contents"),
								data: {"type" : "R"},
								global: false,
								success: function(data, textStatus, jqXHR)
								{
									if (data.RESULT != null)
									{
										let options = [];

									    data.RESULT.forEach(function(element, index) {
									    	options.push("<option value='" + element.cseq + "' data-key='" + element.cseq + "'>" + element.description + " - " + element.name + "</option>");
									    });

									    $("#availableAutority").html(options.join(""));
									    
										$("#availableAutority").dropdown({
											minCharacters: 2,
											placeholder: "Search",
											fullTextSearch: true
										});									    
									};
								}
							});

							let myAuthorityTable = new JpUiTable($("#TBL_myAuthorityList"));
							myAuthorityTable.settings = {
									ajax: {
										url: JpUiGlobal.url("/platform/mgmt/authority/sub_roles"),
										global: false,
										form: $("#FORM_modifyAuthority")
									}
							};
							myAuthorityTable.render();

							$(".BTN_add").on("click", function() {
								let values = $("#availableAutority").dropdown("get value");
								
								if (values == null)
								{
									values = [];
								};
								
								$.each($("#TBL_myAuthorityList").find("input:checkbox[name=cSeq]"), function(i, item) {
									values.push($(this).val());
								});

								myAuthorityTable.settings.ajax.data = "cSeqs=" + values.join(",");
								myAuthorityTable.render();

								$("#availableAutority").dropdown("clear");
								resetCheckAll();
							});

							$(".BTN_remove").on("click", function() {
								myAuthorityTable.remove();
								resetCheckAll();
							});

							function resetCheckAll()
							{
								$("#TBL_myAuthorityList").find("thead .ui.checkbox").checkbox("uncheck");
							};
						};
					};

					changeButtonStatus();
					viewAuthorityTab.changePath(JpUiGlobal.url("/platform/mgmt/authority"));
				}
			}
	};

	viewAuthorityTab.render();

	$("#BTN_createAuthority").on("click", function() {
		showCreateAuthorityArea();		
	});
	
	$(".BTN_modifyAuthority").on("click", function() {
		viewAuthorityTab.changePath(JpUiGlobal.url("/platform/mgmt/authority/modify"));

		changeTab();
	});

	$("#BTN_deleteAuthority").on("click", function() {
		if (getCheckedAuthorityCount() == 0)
		{
			alert("Please choose the authorities to delete.");
			return;
		};

		if (confirm("Do you want to delete the authorities?"))
		{
			JpUtilsAjax.post({
				url: JpUiGlobal.url("/platform/mgmt/authority/delete"),
				data: $("#FORM_search").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					doReload();
				}
			});
		};
	});
	
	function setSeq(seq)
	{
		$("#FORM_search input:checkbox[name=cSeq]:first, #FORM_modifyAuthority input[name=cSeq]").val(seq);
	};

	function getSeq()
	{
		return $("#FORM_modifyAuthority input[name=cSeq]").val(); 
	};		
	
	function initSeq()
	{
		$("#FORM_search input:checkbox[name=cSeq]:first, #FORM_modifyAuthority input[name=cSeq]").val("");
	};
	
	function getCheckedAuthorityCount()
	{
		return authorityTable.getCheckedCount();
	};

	function doSearch(pageNumber)
	{
		$("#FORM_search input:hidden[name=nCseq]").val("");

		doReload(pageNumber)
	};
	
	function doReload(pageNumber)
	{
		$("#FORM_search input:hidden[name=pageNumber]").val(JpUtilsString.defaultString(pageNumber, "1"));
		$("#FORM_search input:hidden[name=rowPerPage]").val("10");		

		authorityTable.load();
	};	

	function hideUserDetailsArea()
	{
		$("#AREA_viewAuthorityDetail").hide();
	};

	function showUserDetailsArea()
	{
		changeTab("general");

		$("#AREA_viewAuthorityDetail").show();
	};
	
	function showCreateAuthorityArea()
	{
		$("#AREA_viewAuthorityDetail .ui.header").html("Create Authority");

		initSeq();

		viewAuthorityTab.changePath(JpUiGlobal.url("/platform/mgmt/authority/modify"));
		changeTab("general");

		$("#AREA_viewAuthorityDetail").show();
	};	

	$("#query").on("keydown", function(event) {
		if (event.keyCode==13)
		{
			doSearch();
		}
	}).on("click", function(event) {
		this.select();
	});

	$("#BTN_searchUser").on("click", function() {
		doSearch();
	});

	$(".BTN_saveAuthority").on("click", function() {
		if ($("#FORM_modifyAuthority").form("validate form"))
		{
			if (viewAuthorityTab.tabPath == "authority")
			{
				$("#TBL_myAuthorityList").find(".ui.checkbox").checkbox("check");
			};
			
			JpUtilsAjax.post({
				url: JpUiGlobal.url("/platform/mgmt/authority/save/" + viewAuthorityTab.tabPath),
				data: $("#FORM_modifyAuthority").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					if (JpUtilsString.isEmpty(getSeq()))
					{
						let cSeq = data.RESULT;
						
						if (JpUtilsObject.isNotNull(cSeq))
						{
							setSeq(cSeq);
							
							$("#FORM_search input:hidden[name=nCseq]").val(cSeq);
						};
					};
					
					//reload 후에는 General Tab 으로 이동하기 때문에 현재 tabPath 를 저장해 둠.
					let currentTabPath = viewAuthorityTab.tabPath;
					
					doReload();
					
					changeTab(currentTabPath);
				}
			});
		}
	});

	$(".BTN_cancelAuthority").on("click", function() {
		if (getSeq() == "")
		{
			hideUserDetailsArea();
		}
		else
		{
			changeTab();	
		};
	});

	function changeButtonStatus()
	{
		$(".AREA_moveToModifyAuthority, .AREA_modifyAuthority").css("display", "none");
		
		if (isOnForm())
		{
			$(".AREA_modifyAuthority").css("display", "block");
		}
		else
		{
			let type = $(authorityTable.getActiveRow()).find("td:eq(1)").html();
			
			if (type == "GROUP")
			{
				if (JpUtilsString.notEquals(viewAuthorityTab.tabPath, "user"))
				{
					$(".AREA_moveToModifyAuthority").css("display", "block");
				}				
			}
		};
	};

	function changeTab(tabPath)
	{
		changeButtonStatus();

		viewAuthorityTab.changeTab(tabPath);
	};
	
	function isCreating()
	{
		if (isOnForm() && getSeq() == "")
		{
			return true;
		}

		return false;
	};
	
	function isOnForm()
	{
		return (viewAuthorityTab.getPath().indexOf("modify") > -1) ? true : false;
	};

	doSearch();
});

</script>

</th:block>
</html>
