<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/popup/index}">	
<th:block layout:fragment="content">
	<style>
	.error {
	  color: red;
	  margin-left: 5px;
	}  
	</style>
	<div class="block-header">
		<div class="block-title" th:text="#{DCP_T_SUBSTITUTION_PARTS}"></div><!-- Substitution Parts -->
		<div class="block-button-area">
			<button id="BTN_download" type="button" th:text="#{DCP_B_DOWNLOAD}"></button><!-- Download -->
			<button id="BTN_search" type="button" th:text="#{DCP_B_SEARCH}"></button><!-- Search -->
		</div>		
	</div>	
	<div class="condition-area">
	<form id="FORM_search" name="FORM_search" onsubmit="return false;">
	<table class="condition">
		<tbody>
			<tr>
				<th th:text="#{DCP_L_PARTS_NO}"></th><!--Parts No  -->
				<td>
					<div class="input-area">
						<input type="text" id="pPartsNo" name="pPartsNo" class="custom-ui-btn" th:value="${pPartsNo}" style="text-transform: uppercase;">
						<button class="btn-popup2" type="button" onclick="showSearchPartsPopup();"></button>
					</div>
				</td>
			</tr>
		</tbody>
	</table>
	</form>	
	</div>
	<div class="split-row"></div>
	<div class="grid-info">
		<div class="grid-total">
			<div class="split"></div>
			<span class="total-number" id="totalRows"></span>
		</div>
	</div>
	<div id="AREA_grid" class="flex-grow grid-area">
		<table id="TBL_grid" class="order-column stripe compact"></table>	
	</div>
	
	<script type="application/javascript">
	let $tableObj;
	let totalRows = 0;
	
	$(function(){	
		$tableObj = $("#TBL_grid").DataTable({
			select: {
				selector: 'td:not(.noselect)'	// noselect class 컬럼은 select 하지 않도록 한다. (input과 충돌 발생)
		    },		   			   			
			ordering: true, 
			scrollY: 100,
			columns: [
				{// 컬럼에 radio 설정
					name: "RAD_MATNR",
					className:"center noselect skip-download",// row selection 기능 막음.
					orderable: false,// checkbox 는 정렬 불가
					render: function(data, type, row)
					{
						if (row.disabled == "disabled")
						{
							return "";
						}
	
						return '<input type="radio" name="RAD_MATNR" id="RAD_MATNR" class="custom-ui" value="' + row.MATNR + '" onchange="syncInput(this)"><label for="RAD_MATNR"></label>';// FixedColumns 사용시엔 syncInput 호출 필요함.
					}
				},			
				{name: "MATNR", 	data: "MATNR", 		title: "[[#{DCP_L_PARTS_NO}]]"	},	// Parts No
				{name: "MAKTX1", 	data: "MAKTX1", 	title: "[[#{DCP_L_DESCRIPTION}]]"	},	// Part No Desc
				{name: "AVA_FLAG", 	data: "AVA_FLAG", 	title: "[[#{DCP_L_AVAILABILITY}]]"	},	// Availability			
				{name: "SEQ", 		data: "SEQ", 		title: "SEQ(Hidden)"	},
				{name: "LABST1", 	data: "LABST1", 	title: "LABST1(Hidden)"	},
				{name: "ITCCD", 	data: "ITCCD", 		title: "ITCCD(Hidden)"	}			
			],		
			columnDefs: [
				{ 
					"targets": [ 4,5,6 ],
	                "visible": false,				
				}			
			],
			ajax: {
				url: "/portal/scm/parts/domestic/info/sub_item_popup_list/data",
				data: function(p)
				{				
					p.pPartsNo = $("#pPartsNo").val();
					p.pPartsNoDesc = $("#pPartsNoDesc").val();
				},
				dataSrc: function(response) 
				{				
					let data = response.RESULT;
					
					for (let i=0, length=data.length; i<length; i++)
					{
						data[i].RAD_MATNR = "";
						data[i].AVA_FLAG = "";
					}
					
					$("#totalRows").html(data.length + " row(s).");
					
					return data;
				}
			},
			initComplete: function() {
				ProgressBar.hide();
			}
		});
		
		// Datatable grid 초기 설정 셋업
		initGridTable($tableObj);		
	
		// Search 버튼 클릭
		$("#BTN_search").on("click", function(){		
		    if (checkValidation())
		    {		
				doSearch();
		    };
		});
		
		//Input text 엔터 키 입력
		$("#pPartsNo").on("keydown", function(event) {
			
			$(this).val($(this).val().toUpperCase());
			
			if (event.keyCode == 13)
			{
				doSearch();
			};
		});		
	
		$("#BTN_download").on("click", function(){		
			let gridFileDownload = new GridFileDownload($tableObj);
			gridFileDownload.fileName = "Substitution_List";
			gridFileDownload.excelDownload();	 
		});
		
		$('#TBL_grid tbody').on('click', 'tr', function (e){				
		    let tblGrid = $('#TBL_grid').DataTable();	    
		    let index = $('#TBL_grid').dataTable().api().cell($(e.target).closest('td')).index().column;	    	    
			let rowData = tblGrid.row(this).data();
			
			let vMATNR = rowData.MATNR;		
			if(index == 0){	
				$("input[name=pPartsNo]", opener.document).val(vMATNR);
				opener.doSearch();
			}					
		});		
	});	
	
	function doSearch()
	{
		$tableObj.ajax.reload();
	};
	
	/*
	 * code(parts)변경 popup	 
	 */ 	
	function showSearchPartsPopup()
	{
		let param = "pPartsNo=" + $("#pPartsNo").val();
		Popup.open("/portal/scm/parts/domestic/info/parts_number_popup_list?" + param, 700, 600);	
	};
	
	function checkValidation()
	{
	    let pPartsNo = $('#pPartsNo').val();
	    let rtnValue = 1;
	    
	    $(".error").remove();
	    
	    if (pPartsNo.length < 1)
	    {
			alert("[[#{DCP_M_EMPTY_PARTS_NO}]]");//Please input Parts No.
	    	rtnValue = -1;
	   	}
	    
	    if (rtnValue > 0)
	    {
	    	return true;
	    };

	    return false;
	};
	
	function setPartsNo(partsNo)
	{
		$("#pPartsNo").val(partsNo);
		doSearch();
	};	
	</script>	
</th:block>
