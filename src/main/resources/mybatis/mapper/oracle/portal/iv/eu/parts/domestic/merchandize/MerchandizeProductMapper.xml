<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.doosan.iv.portal.corp.eu.scm.parts.merchandize.mapper.MerchandizeProductMapper">
	
	<!-- 상품 리스트 검색(관리자)  -->
	<select id="findProductItems" parameterType="MerchandizeProductSearchDto" resultType="MerchandizeProductEntity">
	<include refid="PaginationMapper.header"/>
		select a.mp_seq 
			 , a.mc_seq
			 , a.category_name			 
			 , a.material_no
			 , a.product_name
			 , a.sort	 
			 , a.fg_display	 
			 , a.fg_delete
			 , a.reg_username	 
			 , a.reg_date	 
			 , a.mod_username	 
			 , a.mod_date
			 , #{productImagePath} || (select storage_path || saved_name as image_url from ep_file_upload where t_seq = a.mp_seq and target = 'MALL' and type = 'THUMBNAIL' and fg_delete != 'Y') image_url
		  from 	  
		  (
			select mp.mp_seq 
				 , mp.mc_seq
				 , pack_pltf_lang.func_get_lang
               	   (
               			#{corp},
               			null, 
               			null,
			   			(
		                	select ld.ld_seq
		                  	  from pltf_lang_detail ld, pltf_lang_kind lk
		                 	 where ld.ld_seq in (select ld_seq from ep_mall_lang_rl where t_seq = mp.mc_seq and type='CATEGORY_NAME')
		                       and ld.lk_seq = lk.lk_seq
		                       and lk.corp = #{corp}
		                       and lk.code = 'en'
		                ) 
           	      ) category_name			 
				 , mp.material_no
				 , pack_pltf_lang.func_get_lang
               	   (
               			#{corp},
               			null, 
               			null,
			   			(
		                	select ld.ld_seq
		                  	  from pltf_lang_detail ld, pltf_lang_kind lk
		                 	 where ld.ld_seq in (select ld_seq from ep_mall_lang_rl where t_seq = mp.mp_seq and type='PRODUCT_NAME')
		                       and ld.lk_seq = lk.lk_seq
		                       and lk.corp = #{corp}
		                       and lk.code = 'en'
		                ) 
           	      ) product_name
				 , mp.sort	 
				 , mp.fg_display	 
				 , mp.fg_delete
				 , mc.fg_delete fg_delete_mc
				 , mp.reg_username	 
				 , mp.reg_date	 
				 , mp.mod_username	 
				 , mp.mod_date
			  from ep_mall_product mp, ep_mall_category mc
			 where 1 = 1
			   and mp.mc_seq = mc.mc_seq		   
			   and mc.corp = #{corp} 
			   and mp.fg_delete != 'Y'
			   and mc.fg_delete != 'Y'				   
			 <if test="categoryCode != null and categoryCode != ''">
			   and mc.mc_seq = #{categoryCode}
			 </if>
			 <if test="fgDisplay != null and fgDisplay != ''">
			   and mp.fg_display = #{fgDisplay}
			 </if>
		  ) a
		 where 1 = 1 
		 <if test="productCodeOrName != null and productCodeOrName != ''">
		   and ( upper(a.material_no) like '%' || upper(#{productCodeOrName}) || '%' or upper(a.product_name) like '%' || upper(#{productCodeOrName}) || '%')
		 </if> 
		 order by mc_seq, reg_date desc		
	<include refid="PaginationMapper.footer"/>	 	   
	</select>
	
	
	<!-- 상품 1건 상세 검색(관리자)  -->
	<select id="findProductItem" resultType="MerchandizeProductEntity" parameterType="MerchandizeProductEntity">
		select mp.mp_seq 
			 , mp.mc_seq
             , mc.category_code
			 , mp.material_no	 
			 , mp.sort	 
			 , mp.fg_display	 
			 , mp.fg_delete			 			 
			 , mp.reg_username	 
			 , mp.reg_date	 
			 , mp.mod_username	 
			 , mp.mod_date
		  from ep_mall_product mp, ep_mall_category mc
		 where 1 = 1
		   and mp.mc_seq = mc.mc_seq		   
		   and mc.corp = #{corp} 
		   AND mp.mp_seq = #{mpSeq}		   
	</select>
	
	
	<!-- 상품 등록(관리자) -->
	<insert id="insertProductItem" parameterType="MerchandizeProductEntity">
		<selectKey keyProperty="mpSeq" resultType="Integer" order="BEFORE">
			select ep_mp_seq.nextval from dual
		</selectKey>
		
		insert into ep_mall_product
		(
			mp_seq, mc_seq, material_no, sort, fg_display, fg_delete, reg_username, reg_date, mod_username, mod_date
		)
		values 
		(
			#{mpSeq}, #{mcSeq}, #{materialNo}, (select nvl(max(sort), 0) + 1 from ep_mall_product where mc_seq = #{mcSeq} and fg_delete != 'Y'), #{fgDisplay}, 'N', #{regUsername}, #{regDate}, #{modUsername}, #{modDate}
		)
	</insert>
		
	
	<!-- 상품 수정(관리자) , 삭제(관리자) -->
	<update id="updateProductItem" parameterType="MerchandizeProductEntity">
		update ep_mall_product
		   set mod_date = #{modDate}		     
     		 , mod_username = #{modUsername}
     		 <if test="mcSeq != null and mcSeq != ''">
     		 , mc_seq = #{mcSeq}
     		 </if>     		 
     		 <if test="materialNo != null and materialNo != ''">
     		 , material_no = #{materialNo}
     		 </if>     		 
     		 <if test="sort != null and sort != ''">
     		 , sort = #{sort}
     		 </if>
     		 <if test="fgDisplay != null and fgDisplay != ''">
       	     , fg_display = #{fgDisplay}
       	     </if>
       	     <if test="fgDelete != null and fgDelete != ''">
       	     , fg_delete = #{fgDelete}
       	     </if>	
		 where mp_seq = #{mpSeq}	
	</update>
	
		
	<!-- 상품 등록 시 유효성 체크(관리자) -->
	<select id="verifyProductItem" resultType="MerchandizeProductEntity" parameterType="MerchandizeProductEntity">
		select max(mp.material_no) material_no
		  from ep_mall_category mc, ep_mall_product mp
		 where mc.mc_seq = mp.mc_seq		    
           and mc.fg_delete != 'Y'
           and mp.fg_delete != 'Y'
           and mc.corp = #{corp}
		   and mp.material_no = #{materialNo}
	</select>	
	
	
	<!-- 사용자 Start -->
	
	<!-- 상품 리스트 검색(사용자) -->
	<select id="findProductItemsUser" parameterType="MerchandizeProductSearchDto" resultType="MerchandizeProductEntity">
	<include refid="PaginationMapper.header"/>
		select a.mp_seq 
			 , a.mc_seq		
			 , a.material_no 	 			 
			 , a.material_no || ' | ' || a.product_name as product_name
			 , a.product_description
			 , a.price
			 , a.price_sum
			 , #{productImagePath} || (select storage_path || saved_name as image_url from ep_file_upload where t_seq = a.mp_seq and target = 'MALL' and type = 'THUMBNAIL' and fg_delete != 'Y') image_url
		  from 	  
		  (
			select mp.mp_seq 
				 , mp.mc_seq
				 , pack_pltf_lang.func_get_lang
               	   (
               			#{corp},
               			null, 
               			null,
			   			(
		                	select ld.ld_seq
		                  	  from pltf_lang_detail ld, pltf_lang_kind lk
		                 	 where ld.ld_seq in (select ld_seq from ep_mall_lang_rl where t_seq = mp.mc_seq and type='CATEGORY_NAME')
		                       and ld.lk_seq = lk.lk_seq
		                       and lk.corp = #{corp}
		                       and lk.code = 'en'
		                ) 
           	      ) category_name			 
				 , mp.material_no
				 , pack_pltf_lang.func_get_lang
               	   (
               			#{corp},
               			null, 
               			null,
			   			(
		                	select ld.ld_seq
		                  	  from pltf_lang_detail ld, pltf_lang_kind lk
		                 	 where ld.ld_seq in (select ld_seq from ep_mall_lang_rl where t_seq = mp.mp_seq and type='PRODUCT_NAME')
		                       and ld.lk_seq = lk.lk_seq
		                       and lk.corp = #{corp}
		                       and lk.code = 'en'
		                ) 
           	      ) product_name
				 , pack_pltf_lang.func_get_lang
               	   (
               			#{corp},
               			null, 
               			null,
			   			(
		                	select ld.ld_seq
		                  	  from pltf_lang_detail ld, pltf_lang_kind lk
		                 	 where ld.ld_seq in (select ld_seq from ep_mall_lang_rl where t_seq = mp.mp_seq and type='PRODUCT_DESCRIPTION')
		                       and ld.lk_seq = lk.lk_seq
		                       and lk.corp = #{corp}
		                       and lk.code = 'en'
		                ) 
           	      ) product_description
				 , mp.sort
				 , 0 as price
				 , 0 as price_sum
			  from ep_mall_product mp, ep_mall_category mc
			 where 1 = 1
			   and mp.mc_seq = mc.mc_seq		   
			   and mc.corp = #{corp}
			   and mp.fg_display = 'Y' 
			   and mp.fg_delete != 'Y'
			   and mc.fg_delete != 'Y'			   				   
			 <if test="categoryCode != null and categoryCode != ''">
			   and mc.mc_seq = #{categoryCode}
			 </if>
		  ) a
		 where 1 = 1 
		 <if test="productCodeOrName != null and productCodeOrName != ''">
		   and ( upper(a.material_no) like '%' || upper(#{productCodeOrName}) || '%' or upper(a.product_name) like '%' || upper(#{productCodeOrName}) || '%')
		 </if> 
		 order by sort	
	<include refid="PaginationMapper.footer"/>	 	  
	</select>
	
	<insert id="insertProductItemToCart" parameterType="MerchandizeProductEntity">
	</insert>
	<!-- 사용자 End -->
	
</mapper>