<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/common/index}">
	
<th:block layout:fragment="content">
	<div class="block-header">
		<div class="block-title" th:text="#{DIVUK_TXT_0030}"></div>
		<div class="block-button-area">
			<button id="BTN_search" type="button" th:text="#{DIVUK_BTN_0012}"></button><!-- Search -->		
		</div>
	</div>	
	<div class="condition-area">
	<form id="FORM_search" name="FORM_search">
	<input type="hidden" id="orderNo" name="orderNo">
	<input type="hidden" id="detailDate" name="detailDate">
	<input type="hidden" id="docType" name="docType">	
	<table class="condition">
		<tbody>
			<tr>
				<th th:text="#{DIVUK_LB_0040}"></th><!-- Complaint No. -->
				<td> 
					<div class="input-area">
						<input type="text" id="pComplaintNo" name="pComplaintNo" class="custom-ui" th:value="${pComplaintNo}">
					</div>							
				</td>
				<th th:text="#{DIVUK_LB_0041}"></th><!--Reference No.  -->
				<td>
					<div class="input-area">
						<input type="text" id="pReferenceNo" name="pReferenceNo" class="custom-ui" th:value="${pReferenceNo}">
					</div>				
				</td>			
			</tr>
			<tr>
				<th th:text="#{DIVUK_LB_0042}"></th><!-- Parts No. -->
				<td> 		
					<div class="input-area">
						<input type="text" id="pPartNo" name="pPartNo" class="custom-ui" th:value="${pPartNo}">
					</div>					
				</td>
				<th th:text="#{DIVUK_LB_0043}"></th><!-- Period -->
				<td>
					<div class="input-area">
						<input type="text" id="pFromDate" name="pFromDate" class="custom-ui-calendar" th:value="${pFromDate}">
						<div class="split"></div>
						<input type="text" id="pToDate" name="pToDate" class="custom-ui-calendar" th:value="${pToDate}">
					</div>		
				</td>			
			</tr>				
		</tbody>
	</table>
	</form>
	</div>
	
	<div class="split-row"></div>
	
	<div class="grid-info">
		<div class="grid-total">
			<div class="split"></div>
			<span class="total-number" id="totalRows"></span>
		</div>
	</div>
	
	<div id="AREA_grid" class="flex-grow grid-area">
		<table id="TBL_grid" class="order-column stripe compact"></table>
	</div>
	
	<script type="application/javascript">
	let $tableObj;
	$(function(){
		Calendar.makeBeetweenCalendar($("#pFromDate"), "[[${pFromDate}]]", $("#pToDate"), "[[${pToDate}]]");
	
		$tableObj = $("#TBL_grid").DataTable({
			select: {
				selector: 'td:not(.noselect)'	// noselect class 컬럼은 select 하지 않도록 한다. (input과 충돌 발생)
		    },
			ordering: true, 
			scrollY: 100,
			//fixedColumns: { leftColumns: 3 },
			columns : [
				{data: "VBELN", 		title: "[[#{DIVUK_LB_0040}]]", className:"link"},	//Complaint No.
				{data: "POSNR", 		title: "[[#{DIVUK_LB_0044}]]"},		// Seq.
				{data: "TEXT", 			title: "[[#{DIVUK_LB_0045}]]"},	// Reason
				{data: "ERDAT", 		title: "[[#{DIVUK_LB_0046}]]"},	// Doc. Date
				{data: "VBELN2", 		title: "[[#{DIVUK_LB_0047}]]"},	// Sales Document
				{data: "T_NETWR", 		title: "[[#{DIVUK_LB_0048}]]"},		// Total Amount
				{data: "WAERK", 		title: "[[#{DIVUK_LB_0049}]]"},			// Curr.
				{data: "RFGSK_TX_T", 	title: "[[#{DIVUK_LB_0050}]]"},	// Process Result						
				{data: "RFGSK_TX_T1", 	title: "[[#{DIVUK_LB_0051}]]"},	// Return Status			
				{data: "VBELN3", 		title: "[[#{DIVUK_LB_0052}]]", className:"link"}		// Final Document		
			],
			ajax: {
				url: "/portal/corp/uk/scm/parts/complaint/display/complaint_list/data",
				data: function(p)
				{
					p.pComplaintNo 	= $("#pComplaintNo").val();
					p.pReferenceNo	= $("#pReferenceNo").val();
					p.pPartNo 		= $("#pPartNo").val();
					p.pFromDate 	= $("#pFromDate").val();
					p.pToDate 		= $("#pToDate").val();				
				},
				dataSrc: function(response) 
				{				
					let orderList = response.RESULT.resultOrderList;
					let reasonList1 = response.RESULT.reasonList1;
					
					let returnData = new Array();
											
					for (let i=0, length=orderList.length; i<length; i++)
					{
						orderList[i].SEQ = i+1;	
						orderList[i].TEXT = '';
							
						for (let j=0, length1=reasonList1.length; j<length1; j++)
						{
							if (orderList[i].ZZCMPCD == reasonList1[j].VALUE)
							{
								orderList[i].TEXT = reasonList1[j].TEXT;							
							}
						}
					}				
					$("#totalRows").html(orderList.length+" row(s).");				
					return orderList;
				}			
			},
			initComplete:function(settings, json) 
			{			
				ProgressBar.hide();
			}
		});
		
		// Datatable grid 초기 설정 셋업
		initGridTable($tableObj);
		
		// Search 버튼 클릭
		$("#BTN_search").on("click", function(){		
			doSearch();			// dataTable의 ajax 설정을 이용해  다시 조회. 
		});
		
		//Input text 엔터 키 입력
		$("#FORM_search input:text").on("keydown", function(event) {
			if (event.keyCode == 13)
			{
				doSearch();
			};
		});		
		
		/*
		 *  detail display submit(컴플레인 생성번호)
		 */	
		$('#TBL_grid tbody').on('click', 'tr', function (e){				
		    let tblGrid = $('#TBL_grid').DataTable();	    
		    let index = $('#TBL_grid').dataTable().api().cell($(e.target).closest('td')).index().column;	    	    
			let rowData = tblGrid.row(this).data();
			
			if (index == 0)
			{
				let orderNo = rowData.VBELN;
				let detailDate = rowData.ERDAT;	
				let docType = "A";
				
				if(orderNo != null)
				{							
					$("#orderNo").val(orderNo);			
					$("#detailDate").val(detailDate);
					$("#docType").val(docType);			
					$("#FORM_search").attr("action", "/portal/corp/uk/scm/parts/complaint/display/complaint_detail").submit();
				}			    		    	
			}
			
			if (index == 9)
			{	
				let invoiceNo = rowData.VBELN3;	
				let docType = "C";
				
				if (invoiceNo != null)
				{										
					let param = "pInvoiceNo=" + invoiceNo;
						param = param+"&"+"pType="+docType;			
						param = param+"&"+"pFromDate=1900-01-01";
						param = param+"&"+"pToDate=2900-12-31";
						
					Popup.open("/portal/corp/eu/scm/parts/order/invoice/invoice_status_popup_list?" + param, 1000, 600);				
				}	
			}			
		});			
	});
	
	function doSearch()
	{
		$tableObj.ajax.reload();
	}
	</script>
</th:block>	