<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/iv/hq/parts/common/index}">
<th:block layout:fragment="content">
	<div class="block-header">
		<div class="block-title" th:text="#{PLTF_L_1651928631967}"></div><!-- Invoice Status -->	
		<div class="block-button-area">		
			<button id="BTN_search" type="button" th:text="#{HQP_B_SEARCH}"></button><!-- Search -->
		</div>
	</div>
	<div class="condition-area">
		<form id="FORM_search" name="FORM_search">
			<table class="condition">
				<tbody>
					<tr>
						<th th:text="#{HQP_L_PERIOD}"></th>
						<td colspan="3">
							<div class="input-area">
								<input type="text" id="pFromDate" name="pFromDate" class="custom-ui-calendar" th:value="${pFromDate}"/>
								<input type="text" id="pToDate" name="pToDate" class="custom-ui-calendar to" th:value="${pToDate}"/>
							</div>
						</td>
					</tr>	
				</tbody>
			</table>
		</form>
	</div>
	<div class="split-row"></div>
	<div id="AREA_grid" class="container">
		<table id="TBL_grid" class="condition table-fixed">
			<thead></thead>
			<tbody style="display:block; height:200px; overflow-y: auto;"></tbody>
		</table>
	</div>
<script>
ProgressBar.hide();

let $tableObj;
let columns = [];
let data = [];

$(function(){
	Calendar.makeBeetweenCalendar($("#pFromDate"), "2012.01.01", $("#pToDate"), "[[${pToDate}]]");
	
	//Search 버튼 클릭
	$("#BTN_search").on("click", function(){		
		doSearch(); 
	});
	
	function doSearch()
	{
		JpUtilsAjax.get({
			url: "[[${BASE_PATH}]]/report/order/machine/list/data",		
			data: {"pFromDate": $("#pFromDate").val(), "pToDate": $("#pToDate").val()},
			success: function(response, textStatus, jqXHR)
			{
				let data = response.RESULT;
				
				let from = data.from;
				let to = data.to;
				let models = data.models;
				let values = data.values;
				
				let thead = [];
				let tbody = [];
				
				thead.push("<tr><th></th>");
				
				for (let i=from; i<=to; i++)
				{
					thead.push("<th style='position: sticky; top:0' class='center text-ellipsis' title='" + i + "'>" + i + "</th>");
				};
				
				thead.push("</tr>");
				
				for (let i=0, length=models.length; i<length; i++)
				{
					tbody.push("<tr>");
					tbody.push("<td class='text-ellipsis' title='" + models[i] + "'>" + models[i] + "</td>");
					
					$.each(values[i], function(index, item) {
						let value = (item > 0) ? JpUtilsNumber.addComma(item): "";
						
						tbody.push("<td class='center text-ellipsis'");
						
						if (JpUtilsString.isNotEmpty(value))
						{
							tbody.push(" title='" + value + "'");
						};
						
						tbody.push(">" + value + "</td>");
					});
					
					tbody.push("</tr>");
				};
				
				$("#TBL_grid thead").html(thead.join(""));
				$("#TBL_grid tbody").html(tbody.join(""));
				
				initJpGrid();
			},
			complete: function(jqXHR, textStatus)
			{
				ProgressBar.hide();
			}
		});
		
		function initJpGrid()
		{
			resizeJpGrid();
			
			$(window).resize($.debounce(100, function(e){
				resizeJpGrid();
			}));
		};
		
		function resizeJpGrid()
		{
			let SCROLLBAR_WIDTH = 15; 
			
			let gridWidth = $("#AREA_grid").width();
			
			if ($("body").prop("scrollWidth") > $("body").prop("clientWidth"))
			{
				gridWidth += SCROLLBAR_WIDTH;
			};
			
			$("#TBL_grid tbody").css("width", gridWidth);
			
			let th = $("#TBL_grid thead th");
			
			if (JpUtilsObject.isNotNull(th))
			{
				let td = $("#TBL_grid tbody tr:first td");
				
				if (JpUtilsObject.isNotNull(td))
				{
					let length = td.length;
					let tdWidth = 0;
					let sumTdWidth = 0;

					$.each(td, function(index, element) {
						tdWidth = $(th[index]).outerWidth(true);
						
						if (index == length-1)
						{
							tdWidth = gridWidth - sumTdWidth;
						};
						
						$(element).css("width", tdWidth);
						
						sumTdWidth += tdWidth;
					});
				};
			};
			
			let gridAreaHeight = $("body").outerHeight(true) - $("#AREA_grid").position().top - parseInt($("#AREA_grid").css("margin-top")) - parseInt($("#AREA_grid").css("margin-bottom")) - $(".footer-area").outerHeight(true);
			
			$("#AREA_grid").height(gridAreaHeight);
		};
	};	
});
</script>
</th:block>