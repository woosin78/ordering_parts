<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/iv/hq/parts/common/index}">
	
<th:block layout:fragment="content">
	<div class="block-header">
		<div class="block-title" th:text="#{HQP_T_PARTS_ORDER_REPORT}"></div>
		<div class="block-button-area">
			<!-- button id="BTN_search" type="button" th:text="#{HQP_B_SEARCH}"></button -->
		</div>
	</div>
	<div class="split-row"></div>

	<div class="condition-area">
		<form id="FORM_search" name="FORM_search">
			<table class="condition table-fixed">
				<tbody>
					<tr>
						<th th:text="#{HQP_L_YEAR}"></th>
						<td>
							<div class="input-area">
								<select id="pYear" name="pYear" class="custom_ui">
									<option th:each="year: ${#numbers.sequence(thisYear, thisYear-1)}" th:value="${year}" th:text="${year}" th:selected="${year}==${pYear}"></option>
								</select>
							</div>
						</td>
					</tr>
					<tr>
						<th th:text="#{HQP_L_TYPE}"></th>
						<td>
							<div class="input-area">
								<select id="type" name="type" class="custom-ui">
									<option value="monthly" selected th:text="#{HQP_L_REPORT_TYPE_MONTHLY}"></option>
									<option value="order_type" th:text="#{HQP_L_REPORT_TYPE_ORDER_TYPE}"></option>
								</select>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</form>
	</div>	
	
	<div class="condition-area">
		<div class="condition-title right"><span th:text="|#{HQP_L_CURR}:|"></span> <span id="curr"></span></div>
		<table class="condition table-fixed order-report">
			<thead>
				<tr><th>&nbsp;</th></tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>
	<div class="split-row-compact"></div>
	<div id="AREA_chart" style="width:60%; margin: auto; "></div>
	
<script>
$(document).ready(function() {
	ProgressBar.hide();
	
	function drawTable(result)
	{
		let column = result.BW_COLUMN;
		let data = result.BW_DATA;
		let axis = result.BW_AXIS;
		
		let thead = [];
		let tbody = [];
		
		thead.push("<tr><th></th>");
		
		$.each(column, function(index, item) {
			thead.push("<th class='center text-ellipsis' title='" + item.CAPTION + "'>");
			thead.push(item.CAPTION);
			thead.push("</th>");
		});
		
		thead.push("</tr>");
		
		$.each(axis, function(index1, item1) {
			tbody.push("<tr>");
			tbody.push("<td class='text-ellipsis' title='" + axis[index1].CAPTION + "'>" + axis[index1].CAPTION + "</td>");
			
			$.each(data[index1], function(index2, item2) {
				let value = item2.VALUE;

				if (item2.MWKZ == "%")
				{
					value = Number(value).toFixed(2);
				};
				
				let formattedValue = JpUtilsNumber.addComma(value);
				
				tbody.push("<td class='right text-ellipsis' title='" + formattedValue + "'>");
				tbody.push(formattedValue);
				tbody.push("</td>");
			});
			
			tbody.push("</tr>");
		});

		$("table.order-report > thead").html(thead.join(""));
		$("table.order-report > tbody").html(tbody.join(""));
		
		$("#curr").html(data[0][0].CURRENCY);
	};
	
	function drawChart(result)
	{
		let column = result.BW_COLUMN;
		let data = result.BW_DATA;
		let axis = result.BW_AXIS;		
		
		let chartData = [];
		let xAxis = [];
		
		$.each(column, function(index, item) {
			if (index >=1 && index <= 12)
			{
				xAxis.push(item.CAPTION);	
			};
		});
		
		$.each(axis, function(index1, item1) {
			
			if (index1 <= 1 || index1 == 3)
			{
				let chartColumn = [];
				chartColumn.push(axis[index1].CAPTION);
				
				$.each(data[index1], function(index2, item2) {
					if (index2 >= 1 && index2 <= 12)
					{
						let value = (item2.MWKZ == "%") ? Number(item2.VALUE).toFixed(2) : item2.VALUE;
						
						chartColumn.push(value);						
					};
				});
				
				chartData.push(chartColumn);				
			};
		});			

		let chart = c3.generate({
			bindto: "#AREA_chart",
			data: {
				columns: chartData,
				labels: false
			},
			axis: {
				x: {
					label: {
						text: "Month",
						position: "outer-center"
					},
					type: "category",
					categories: xAxis
				},
				y: {
					label: {
						text: "Order Amount",
						position: "outer-middle"
					},
					tick: {
						format: d3.format(",")
					}
				}
			}
		});
	};	
	
	function load()
	{
		JpUtilsAjax.get({
			url: "[[${BASE_PATH}]]/report/order/monthly/list/data",
			data: {"pYear": $("#pYear").val()},
			beforeSend: function(jqXHR, settings) {
				ProgressBar.show();
			},
			success: function(response, textStatus, jqXHR)
			{
				let result = response.RESULT;
				
				drawTable(result);
				drawChart(result);
			},
			complete(jqXHR, textStatus) {
				ProgressBar.hide();
			}
		});		
	};
	
	function doSearch()
	{
		load();
	};
	
	$("#BTN_search").on("click", function() {
		doSearch();
	});
	
	$("#pYear").on("change", function() {
		doSearch();
	});	
	
	$("#type").on("change", function() {
		document.location.href = "[[${BASE_PATH}]]/report/order/" + $(this).val() + "/list?pYear=" + $("#pYear").val();
	});
	
	doSearch();
});
</script>	
</th:block>