<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/iv/hq/parts/common/index}">

<th:block layout:fragment="content">
<style> 
body {
	overflow-y: scroll;
}
</style>
	<script src="/editor_html5/js/xfe_main.js"></script>
	
	<!-- Modal for upload simulation -->	
	<div class="dropzone-dimmer dimmer"></div>		
	<div class="dropzone-area">
		<div class="dropzone-area-top"></div>
		<div class="dropzone-body dropzone-click-zone">
			<div class="dropzone-click-zone" style="height:20px"></div>
			<img class="dropzone-body-img dropzone-click-zone" src="/portal/img/icon/upload_file.png"/>
			<div class="dropzone-body-content dropzone-click-zone" th:text="#{HQP_T_HOW_TO_UPLOAD_EXCEL}"></div>
			<div class="dropzone-body-content dropzone-click-zone" th:text="#{HQP_T_ITEMS_COPY_PASTE2}"></div>
			<hr style="width:95%;"/>
			<div class="dropzone-body-content dropzone-click-zone">
				<span class="bold">*[[#{HQP_T_GUIDE_ORDER_UPLOAD_FORM1}]]</span><br/>
				- A: [[#{HQP_T_PROMOTION_MATERIAL}]]
				<img class="dropzone-body-img dropzone-click-zone" src="/portal/img/iv/hq/parts/common/upload_form2.png"/>
			</div>
		</div>
		<div class="dropzone-bottom dropzone-click-zone">
			<button type="button" onclick="UploadModal.hide()">[[#{HQP_B_CANCEL}]]</button>
		</div>
	</div>
	<!-- Modal for upload simulation -->	
	
	<div class="block-header">
		<div class="block-title" th:text="#{HQP_T_PROMOTION}"></div>
		<div class="block-button-area">
			<button id="BTN_save" type="button" th:text="#{HQP_B_SAVE}"></button>
			<button id="BTN_back" type="button" th:text="#{HQP_B_BACK}"></button>
		</div>	
	</div>	
	<div id="boardViwer" class="condition-area" > <!-- style="overflow:auto;" -->
	<form id="FORM_write" method="post" th:action="|${BASE_PATH}/promotion/save|" enctype="multipart/form-data" autocomplete="off" onsubmit="return false;">
	<input type="hidden" name="pSeq" id="pSeq" th:value="${promotion?.pSeq}"/>
	<input type="hidden" name="textContent" id="textContent" th:value="${promotion?.textContent}"/>
	<input type="hidden" name="htmlContent" id="htmlContent" th:value="${promotion?.htmlContent}"/>	
	<input type="file" name="files" id="files" style="display:none;"/>
	<input type="file" name="files2" id="files2" multiple style="display:none;"/>
	<table class="condition table-fixed">
		<tbody>
			<tr>
				<th>[[#{HQP_L_TITLE}]]<img src="/portal/img/icon/required.png" class="required" /></th>
				<td>
					<input type="text" id="title" name="title" class="custom-ui" th:value="${promotion?.title}"/>
				</td>
			</tr>
			<tr>
				<th>[[#{HQP_L_CONTENT}]]<img src="/portal/img/icon/required.png" class="required" /></th>
				<td><div id="xfe"></div></td>
			</tr>
			<tr >
				<th th:text="#{HQP_L_VISIBLE_TARGET}"/> 
				<td>
					<div class="split-row-more-compact"></div>
					<div class="input-area"><input type="text" id="searchVisibleTarget" name="searchVisibleTarget" class="custom-ui autocomplete" th:placeholder="#{HQP_L_PLACEHOLD_DEALER_CODE_NAME}"/></div>
					<div class="split-row-more-compact"></div>
					<button id="BTN_deleteVisibleTarget" type="button" th:text="#{HQP_B_DELETE}" class="small_button"></button>
					<div class="split-row-more-compact"></div>
					<div style="display: block; height: 1px; background-color: #cccccc; margin-top:2px; margin-bottom:2px;"></div>
					<div class="split-row-more-compact"></div>
					<div id="addedTargets">
						<div th:each="promotionTarget : ${promotion?.promotionTargets}">
							<input type="checkbox" class="custom-ui visible-target"/><label th:text="${promotionTarget.code}"></label>
							<div class="split2"></div><span th:text="${promotionTarget.description}"></span>
							<input name="targetCode" type="hidden" th:value="${promotionTarget.code}"/>
							<input name="targetDescription" type="hidden" th:value="${promotionTarget.description}"/>
						</div>
					</div>
				</td>
			</tr>
			<tr >
				<th>[[#{HQP_L_VISIBLE_PERIOD}]]<img src="/portal/img/icon/required.png" class="required" /></th>
				<td>
					<div class="input-area period">
						<span th:text="#{HQP_L_FROM}" class="label"></span>
						<input type="text" id="fromViewDate" name="fromViewDate" class="custom-ui-calendar" th:value="${promotion?.fromViewDate}"/>
						<div class="split3"></div>
						<select id="fromViewHours" name="fromViewHours" class="custom-ui hours">
							<option value=""></option>
							<option th:each="num : ${#numbers.sequence(0,23)}" th:with="num=${#numbers.formatInteger(num, 2)}" th:value="${num}" th:text="${num}" th:selected="${num eq promotion?.fromViewHours}"/>
						</select>
						<span th:text="#{HQP_L_HOURS}"></span>
						<select id="fromViewMinutes" name="fromViewMinutes" class="custom-ui minutes">
							<option value=""></option>
							<option th:each="num : ${#numbers.sequence(0,59)}" th:with="num=${#numbers.formatInteger(num, 2)}" th:value="${num}" th:text="${num}" th:selected="${num eq promotion?.fromViewMinutes}"/>
						</select>
						<span th:text="#{HQP_L_MINUTES}"></span>
					</div>
					<div class="split-row-more-compact"></div>
					<div class="input-area period">
						<span th:text="#{HQP_L_TO}" class="label"></span>
						<input type="text" id="toViewDate" name="toViewDate" class="custom-ui-calendar" th:value="${promotion?.toViewDate}"/>
						<div class="split3"></div>
						<select id="toViewHours" name="toViewHours" class="custom-ui hours">
							<option value=""></option>
							<option th:each="num : ${#numbers.sequence(0,23)}" th:with="num=${#numbers.formatInteger(num, 2)}" th:value="${num}" th:text="${num}" th:selected="${num eq promotion?.toViewHours}"/>
						</select>
						<span th:text="#{HQP_L_HOURS}"></span>
						<select id="toViewMinutes" name="toViewMinutes" class="custom-ui minutes">
							<option value=""></option>
							<option th:each="num : ${#numbers.sequence(0,59)}" th:with="num=${#numbers.formatInteger(num, 2)}" th:value="${num}" th:text="${num}" th:selected="${num eq promotion?.toViewMinutes}"/>
						</select>
						<span th:text="#{HQP_L_MINUTES}"></span>
					</div>
				</td>
			</tr>
			<tr >
				<th>[[#{HQP_L_POPUP_SIZE}]]</th>
				<td>
					<div class="input-area popup">
						<span th:text="#{HQP_L_WIDTH}" class="label"></span>
						<input type="text" class="custom-ui-scope" id="width" name="width" th:value="${promotion?.width}" th:placeholder="#{HQP_L_PLACEHOLD_PIXEL}" />
					</div>
					<div class="split-row-more-compact"></div>
					<div class="input-area popup">
						<span th:text="#{HQP_L_HEIGHT}" class="label"></span>
						<input type="text" class="custom-ui-scope" id="height" name="height" th:value="${promotion?.height}" th:placeholder="#{HQP_L_PLACEHOLD_PIXEL}" />
					</div>
				</td>
			</tr>
			<tr >
				<th>[[#{HQP_L_BANNER_IMAGE}]] <img src="/portal/img/icon/required.png" class="required" /></th> 
				<td>
					<div id="banner"></div>
					<div th:text="#{HQP_T_RECOMENDED_SIZE}" class="warn"></div>
				</td>
			</tr>		
			<tr >
				<th th:text="#{HQP_L_ATTACHMENT}"/>
				<td id="attachment"></td>
			</tr>	
			<tr >
				<th th:text="#{HQP_L_PROMOTION_MATERIAL}"/>
				<td>
					<div class="split-row-more-compact"></div>
					<div class="input-area"><input type="text" id="searchVisibleItem" name="searchVisibleItem" class="custom-ui autocomplete" th:placeholder="#{HQP_L_MATERIAL_NO}"/></div>
					<div class="split-row-more-compact"></div>
					<button id="BTN_uploadVisibleItem" type="button" th:text="#{HQP_B_UPLOAD}" class="small_button"></button><div class="split"></div><button id="BTN_checkAllVisibleItem" type="button" th:text="#{HQP_B_SELECT_ALL}" class="small_button"></button><div class="split"></div><button id="BTN_deleteVisibleItem" type="button" th:text="#{HQP_B_DELETE}" class="small_button"></button>
					<div class="split-row-more-compact"></div>
					<div style="display: block; height: 1px; background-color: #cccccc; margin-top:2px; margin-bottom:2px;"></div>
					<div class="split-row-more-compact"></div>
					<div id="addedItems">
						<div th:each="promotionItem : ${promotion?.promotionItems}">
							<input type="checkbox" class="custom-ui visible-item"/><label th:text="${promotionItem.materialNo}"></label>
							<div class="split2"></div><span th:text="${promotionItem.materialText}"></span>
							<input name="materialNo" type="hidden" th:value="${promotionItem.materialNo}"/>
						</div>
					</div>
				</td>
			</tr>	
		</tbody>
	</table>
	</form>
	</div>
	<form id="FORM_search" th:action="|${BASE_PATH}/promotion/list|" th:object="${promotionSearch}">
	<input type="hidden" name="pSeq" th:value="${pSeq}"/>
	<input type="hidden" name="title" th:value="${title}"/>
	<input type="hidden" name="fromRegDate" th:value="${fromRegDate}"/>
	<input type="hidden" name="toRegDate" th:value="${toRegDate}"/>
	<input type="hidden" name="pageNumber" th:value="${pageNumber}"/>
	<input type="hidden" name="state" th:value="${state}"/>
	</form>

<script th:inline="javascript">
let bannerUploader;
let fileUploader;

$(function(){
	bannerUploader = _setFileUploader($("#banner"));
	
	/*[# th:each="uploadFileList : ${promotion?.uploadFileLists}"]*/
	bannerUploader.addFile(/*[[${uploadFileList.fullOriginName}]]*/, /*[[${uploadFileList.fileSize}]]*/, /*[[${uploadFileList.uflSeq}]]*/);
	/*[/]*/
	
	fileUploader = _setFileUploader($("#attachment"), "files2", "uflSeqs2");
	
	/*[# th:each="uploadFileList : ${promotion?.uploadFileLists2}"]*/
	fileUploader.addFile(/*[[${uploadFileList.fullOriginName}]]*/, /*[[${uploadFileList.fileSize}]]*/, /*[[${uploadFileList.uflSeq}]]*/);
	/*[/]*/	
});
</script>
	
<script>
$(function(){
	Calendar.makeCalendar($("#fromViewDate"), "[[${promotion?.displayFromView}]]");
	Calendar.makeCalendar($("#toViewDate"), "[[${promotion?.displayToView}]]");
});

let UploadModal = {};
UploadModal.show = function() {
	let width = 480;
	let height = 450;
	let left = ($(window).innerWidth() - width) * 0.5;
	let top = ($(window).innerHeight() - height) * 0.5;

	$(".dropzone-area").css({
		"width": width,
		"height": height,
		"left": left,
		"top": top
	});
	
	$(".dropzone-dimmer").css({
		"width": "100%",
		"height": "100%"
	});

	$(".dropzone-dimmer, .dropzone-area").show();
	
	$(document).on("paste", function(event) {
		triggerPasteFromClipload(event);
	});
};

UploadModal.hide = function()
{
	$(".dropzone-dimmer, .dropzone-area").hide();
	
	$(document).off("paste");
};

$(".dropzone-click-zone").dropzone({
	url: "/portal/iv/parts/search/upload/data",
	maxFilesize: 5, //MB
	acceptedFiles: ".xlsx",
	accept: function(file, done)
	{
		console.log("accept");
		done();
	},
	addedfile: function(file)
	{
	},
	sending: function(file, xhr, formData)
	{
		xhr.setRequestHeader(JpUtilsSecurity.CSRF.NAME, JpUtilsSecurity.CSRF.TOKEN);
		ProgressBar.show();
	},
	success: function(file, response)
	{
		getTargetItems(response.RESULT);
	},
	complete: function(file)
	{
		UploadModal.hide();
	},
	error: function(file, error, xhr)
	{
		ProgressBar.hide();
		UploadModal.hide();
	},
	drop: function()
	{
		//console.log("drop");
	},
	dragenter: function(e)
	{
		//console.log("dragenter");
	},
	dragover: function(e)
	{
		//console.log("dragover");
	},
	dragleave: function(e)
	{
		//console.log("dragleave");
	}
});

function triggerPasteFromClipload(event)
{
	let rows = event.originalEvent.clipboardData.getData("Text").split(String.fromCharCode(13));//13:CR
	let items = [];
	
	$.each(rows, function(index, element) {
		if (JpUtilsString.isNotEmpty(element))
		{
			items.push(JpUtilsString.trimToEmpty(element));
		};
	});
	
	getTargetItems(items);
	
	UploadModal.hide();
};

function getTargetItems(items)
{
	if (items.length > 0)
	{
		ProgressBar.show();
		
		JpUtilsAjax.get({
			url: "/portal/iv/parts/search/data",
			data: {"pPartNo": items.join(GLOBAL_CONST.DELIMITER)},
			success: function(data, textStatus, jqXHR)
			{
				let result = data.RESULT;
	
				$.each(result, function(index, element) {
					addTargetItem(element.MATERIAL + "|" + element.MATERIAL_TEXT, element.MATERIAL);					
				});
			},
			complete: function(jqXHR, textStatus)
			{
				ProgressBar.hide();
			}
		});		
	};
};

function addTargetItem(label, value)
{
	if ($("#addedItems label:contains('" + value + "')").length == 0)
	{
		let str = label.split("|");
		
		let materialNo = JpUtilsString.trimToEmpty(str[0]);
		let materialText = JpUtilsString.trimToEmpty(str[1]);		
		
		let html = [];
		html.push("<div>");
		html.push("<input type='checkbox' class='custom-ui visible-target'/><label>" + materialNo + "</label>");
		html.push("<div class='split2'></div><span>" + materialText + "</span>");
		html.push("<input name='materialNo' type='hidden' value='" + JpUtilsString.trimToEmpty(materialNo) + "'/>");
		html.push("</div>");
		
		$("#addedItems").append(html.join(""));
	};
};

$(window).on("load", function() {
	ProgressBar.hide();
	
	_setDealerCodeAutocomplete($("#searchVisibleTarget"), {
		select: function(label, value, event) {
			addVisibleTarget(label, value);
			 
			$("#searchVisibleTarget").val("");
		}
	});
	
	_setPartAutocomplete($("#searchVisibleItem"), {
		select: function(label, value, event) {
			addTargetItem(label, value);
			 
			$("#searchVisibleItem").val("");
		}
	});
});

$("#BTN_deleteVisibleTarget").on("click", function(event) {
	$.each($("#FORM_write .visible-target"), function(i, item) {
		if ($(this).is(":checked"))
		{
			$(this).closest("div").remove();
		};
	});
});	

function addVisibleTarget(label, value)
{
	let str = label.split("|");
	
	let dealerCode = JpUtilsString.trimToEmpty(str[0]);
	let dealerName = JpUtilsString.trimToEmpty(str[1]);
	
	if ($("#FORM_write label:contains('" + dealerCode + "')").length == 0)
	{
		let html = [];
		
		html.push("<div>");
		html.push("<input type='checkbox' class='custom-ui visible-target'/><label>" + value + "</label><div class='split2'></div>");
		html.push("<span>" + dealerName + "</span>");
		html.push("<input name='targetCode' type='hidden' value='" + JpUtilsString.trimToEmpty(value) + "'/>");
		html.push("<input name='targetDescription' type='hidden' value='" + JpUtilsString.trimToEmpty(dealerName) + "'/>");
		html.push("</div>");
		
		$("#addedTargets").append(html.join(""));
	};
};

$("#BTN_uploadVisibleItem").on("click", function() {
	UploadModal.show();
});

$("#BTN_checkAllVisibleItem").on("click", function() {
	let isCheckAll = $(this).prop("isCheckAll") ? false : true;
	
	$("#addedItems input[type=checkbox]").prop("checked", isCheckAll);
	
	$(this).prop("isCheckAll", isCheckAll);
});

$("#BTN_deleteVisibleItem").on("click", function(event) {
	$.each($("#FORM_write .visible-item"), function(i, item) {
		if ($(this).is(":checked"))
		{
			$(this).closest("div").remove();
		};
	});
});	

$("#BTN_back").on("click", function() {
	let action = (JpUtilsString.isNotEmpty("[[${promotion?.pSeq}]]")) ? "[[${BASE_PATH}]]/promotion/view" : "[[${BASE_PATH}]]/promotion/list";
	
	$("#FORM_search")
		.attr("action", action)
		.submit();
});

$("#BTN_save").on("click", function() {
	if (JpUtilsString.isEmpty($("#title").val()))
	{
		alert("[[#{HQP_M_EMPTY_TITLE}]]");
		$("#title").focus();
		return;
	};

	if (JpUtilsString.isEmpty(xfe.getTextValue()))
	{
		alert("[[#{HQP_M_EMPTY_CONTENT}]]");
		return;
	};
	
	if (JpUtilsString.isAnyEmpty($("#fromViewDate").val(), $("#fromViewHours").val(), $("#fromViewMinutes").val(), $("#toViewDate").val(), $("#toViewHours").val(), $("#toViewMinutes").val()))
	{
		alert("[[#{HQP_M_EMPTY_VISIBLE PERIOD}]]");
		return;
	}
	
	if (0 == bannerUploader.getFileCount())
	{
		alert("[[#{HQP_M_EMPTY_BANNER}]]");
		return;
	};

	$("#textContent").val(xfe.getTextValue());
	$("#htmlContent").val(xfe.getBodyValue());
	
	ProgressBar.show();

	let options = {
			enctype: "multipart/form-data",
			url: "[[${BASE_PATH}]]/promotion/save",
			data: new FormData($("#FORM_write")[0]),
			global: false,
			processData: false,
			contentType: false,
			cache: false,
			success: function(data, textStatus, jqXHR) {
				//console.log('data', data);
				$("#FORM_search input[name=pSeq]").val(data.RESULT);				
				$("#BTN_back").trigger("click");
				ProgressBar.show();
			},
			error: function(jqXHR, textStatus, errorThrown) {
				let response = JSON.parse(jqXHR.responseText);
				
				alert("[[#{HQP_M_FAIL_SAVE}]]\n" + response.MESSAGE);
				
				ProgressBar.hide();
			}
	};
	
	JpUtilsAjax.post(options);
});

/*
 * 에디터 생성.
 * 
 * basePath : 에디터 모듈이 있는 폴더의 Url 경로를 적어줍니다. (필수)
 * width : 에디터의 너비
 * height : 에디터의 높이
 * onLoad : 에디터 초기 로드 이벤트				 
 */
let xfe = new XFE({
	basePath: "[[@{/editor_html5}]]",
	width: "100%",
	height: "100%",
	onLoad: function() {
		xfe.setBodyValue($("#htmlContent").val());	
	},
	language: ((JpUtilsString.equals(GLOBAL_CONST.LANG, "KO")) ? "korean" : "english"),
	initFontFamily: (JpUtilsString.equals(GLOBAL_CONST.LANG, "KO")) ? "맑은 고딕" : "Arial",
});
	
xfe.render("xfe");
</script>
</th:block>								