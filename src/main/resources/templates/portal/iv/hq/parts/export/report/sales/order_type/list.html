<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/iv/hq/parts/common/index}">
	
<th:block layout:fragment="content">
	<div class="block-header">
		<div class="block-title" th:text="#{PLTF_L_1651725228840}"></div>
		<div class="block-button-area">
			<!-- button id="BTN_search" type="button" th:text="#{HQP_B_SEARCH}"></button -->
		</div>
	</div>
	<div class="split-row"></div>

	<div class="condition-area">
		<form id="FORM_search" name="FORM_search">
			<table class="condition table-fixed">
				<tbody>
					<tr>
						<th th:text="#{HQP_L_YEAR}"></th>
						<td>
							<div class="input-area">
								<select id="pYear" name="pYear" class="custom_ui">
									<option th:each="year: ${#numbers.sequence(thisYear, 2012)}" th:value="${year}" th:text="${year}" th:selected="${year}==${pYear}"></option>
								</select>
							</div>
						</td>
					</tr>
					<tr>
						<th th:text="#{HQP_L_TYPE}"></th>
						<td>
							<div class="input-area">
								<select id="type" name="type" class="custom-ui">
									<option value="monthly" th:text="#{HQP_L_REPORT_TYPE_MONTHLY}"></option>
									<option value="order_type" selected th:text="#{HQP_L_REPORT_TYPE_ORDER_TYPE}"></option>
								</select>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</form>
	</div>	
	
	<div class="condition-area">
		<div class="condition-title right"><span th:text="|#{HQP_L_CURR}:|"></span> <span id="curr"></span></div>
		<div style="height:250px; overflow-y: auto; border: 1px solid #003081;">
			<table class="condition table-fixed order-report table-none-border">
				<thead>
					<tr><th>&nbsp;</th></tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
	</div>
	<div class="split-row-compact"></div>
	<!-- div id="AREA_chart" style="width:60%; margin: auto; "></div -->
	
<script>
$(document).ready(function() {
	ProgressBar.hide();
	
	function drawTable(result)
	{
		let column = result.BW_COLUMN;
		let data = result.BW_DATA;
		let axis = result.BW_AXIS;
		
		let thead = [];
		let tbody = [];
		let currency = "";
		
		if (JpUtilsObject.isNotNull(column))
		{
			thead.push("<tr><th style='position: sticky; top:0'>&nbsp;</th>");
			
			$.each(column, function(index, item) {
				thead.push("<th style='position: sticky; top:0' class='center text-ellipsis' title='" + item.CAPTION + "'>");
				thead.push(item.CAPTION);
				thead.push("</th>");
			});
			
			thead.push("</tr>");
			
			$.each(axis, function(index1, item1) {
				tbody.push("<tr>");
				tbody.push("<td class='text-ellipsis' title='" + axis[index1].CAPTION + "'>" + axis[index1].CAPTION + "</td>");
				
				$.each(data[index1], function(index2, item2) {
					let value = item2.VALUE;

					if (item2.MWKZ == "%")
					{
						value = Number(value).toFixed(2);
					};
					
					let formattedValue = JpUtilsNumber.addComma(value);
					
					tbody.push("<td class='right text-ellipsis' title='" + formattedValue + "'>");
					tbody.push(formattedValue);
					tbody.push("</td>");
					
					if (JpUtilsString.isEmpty(currency) && JpUtilsString.isNotEmpty(item2.CURRENCY))
					{
						currency = item2.CURRENCY; 
					};
				});
				
				tbody.push("</tr>");
			});			
		}
		else
		{
			thead.push("<tr><th class='center'>&nbsp;</th></tr>");
			tbody.push("<tr><td class='center'>[[#{HQP_T_EMPTY_RESULT}]]</td></tr>");
		};

		$("table.order-report > thead").html(thead.join(""));
		$("table.order-report > tbody").html(tbody.join(""));
		
		$("#curr").html(currency);
	};
	
	function drawChart(result)
	{
		let column = result.BW_COLUMN;
		let chartData = [];
		let xAxis = [];
		let groups = new Array();
		groups.push(new Array());		
		
		if (JpUtilsObject.isNotNull(column))
		{
			let data = result.BW_DATA;
			let axis = result.BW_AXIS;
			let axisLength = axis.length;
			
			$.each(column, function(index, item) {
				if (index >=0 && index <= 11)
				{
					xAxis.push(item.CAPTION);	
				};
			});

			$.each(axis, function(index1, item1) {
				
				if (index1 >= 0 && index1 <= axisLength-4 && index1%2 == 0)
				{
					let chartColumn = [];
					chartColumn.push(axis[index1].CAPTION);
					
					$.each(data[index1], function(index2, item2) {
						if (index2 >= 0 && index2 <= 11)
						{
							let value = (item2.MWKZ == "%") ? Number(item2.VALUE).toFixed(2) : item2.VALUE;
							
							chartColumn.push(value);						
						};
					});
					
					chartData.push(chartColumn);
					
					groups[0].push(axis[index1].CAPTION);
				};
			});
		};

		let chart = c3.generate({
			bindto: "#AREA_chart",
			data: {
				columns: chartData,
				labels: false,
				type: "bar",
				groups: groups
			},
			axis: {
				x: {
					label: {
						text: "Month",
						position: "outer-center"
					},
					type: "category",
					categories: xAxis
				},
				y: {
					label: {
						text: "Sales Amount",
						position: "outer-middle"
					},
					tick: {
						format: d3.format(",")
					}
				}
			}
		});
	};		
	
	function load()
	{
		JpUtilsAjax.get({
			url: "[[${BASE_PATH}]]/report/sales/order_type/list/data",
			data: {"pYear": $("#pYear").val()},
			beforeSend: function(jqXHR, settings) {
				ProgressBar.show();
			},
			success: function(response, textStatus, jqXHR)
			{
				let result = response.RESULT;
				
				drawTable(result);
				//drawChart(result);
			},
			complete: function(jqXHR, textStatus)
			{
				ProgressBar.hide();
			}
		});		
	};
	
	function doSearch()
	{
		load();
	};
	
	$("#BTN_search").on("click", function() {
		doSearch();
	});
	
	$("#pYear").on("change", function() {
		doSearch();
	});	
	
	$("#type").on("change", function() {
		document.location.href = "[[${BASE_PATH}]]/report/sales/" + $(this).val() + "/list?pYear=" + $("#pYear").val();
	});
	
	doSearch();
});
</script>	
</th:block>