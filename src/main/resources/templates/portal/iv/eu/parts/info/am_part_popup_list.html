<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/popup/index}">	
<th:block layout:fragment="content">
<style>
.error {
  color: red;
  margin-left: 5px;
}  
</style>
<div class="block-header">
	<div class="block-title">Certified Program</div><!--TODO 다국어  -->
	<div class="block-button-area">
		<button id="BTN_search" type="button" th:text="#{DIVEU_BTN_0002}"></button><!-- Search -->
		<!-- button id="BTN_close" type="button" th:text="#{DIVUK_BTN_0005}"></button><!-- Close -->		
	</div>	
</div>	
<div class="condition-area">
<form id="FORM_search" name="FORM_search" onsubmit="return false;">
<table class="condition">
	<tbody>
		<tr>
			<th th:text="#{DIVEU_LB_0134}"></th><!-- Parts No -->
			<td>
				<div class="input-area">
					<input type="text" id="pPartsNo" name="pPartsNo" class="custom-ui-btn" th:value="${pPartsNo}" style="text-transform: uppercase;">
					<button class="btn-popup2" type="button" onclick="searchParts();"></button>
					<input type="hidden" id="pPlant" th:value="${pPlant}">
				</div>
			</td>
		</tr>
	</tbody>
</table>
</form>	
</div>
<div class="split-row"></div>
<div class="grid-info">
	<div class="grid-total">
		<div class="split"></div>
		<span class="total-number" id="totalRows"></span>
	</div>
</div>
<div id="AREA_grid" class="flex-grow grid-bottom-area">
	<table id="TBL_grid" class="order-column stripe compact"></table>	
</div>

<script type="application/javascript">
var $tableObj;
var totalRows = 0;

$(function(){	
	$tableObj = $("#TBL_grid").DataTable({
		select: {
			selector: 'td:not(.noselect)'	// noselect class 컬럼은 select 하지 않도록 한다. (input과 충돌 발생)
	    },		   			   			
		ordering: true, 
		scrollY: 100,
		columns: [
			{// 컬럼에 radio 설정
				name: "RAD_MATNR",
				className:"center noselect skip-download",// row selection 기능 막음.
				orderable: false,// checkbox 는 정렬 불가
				render: function(data, type, row)
				{
					if (row.disabled == "disabled")
					{
						return "";
					}

					return '<input type="radio" name="RAD_MATNR" id="RAD_MATNR" class="custom-ui" value="' + row.AM_PART_NO + '"><label for="RAD_MATNR"></label>';// FixedColumns 사용시엔 syncInput 호출 필요함.
				}
			},			
			{name: "AM_PART_NO", 	 data: "AM_PART_NO", 	title: "[[#{DIVEU_LB_0134}]]"	},	// Part No Desc
			{name: "ORIGIN_PART_NO", data: "ORIGIN_PART_NO",title: "Original Part No"		},	// TODO 다국어
			{name: "ORIGIN_COUNTRY", data: "ORIGIN_COUNTRY",title: "Country of Origin",  class: "center"	},	// TODO 다국어		
			{name: "SEQ", 			 data: "SEQ", 			title: "SEQ(Hidden)"	}
		],		
		columnDefs: [
			{ 
				"targets": [ 4 ],
                "visible": false,				
			}			
		],
		ajax: {
			url: "/portal/corp/eu/scm/parts/info/am_part_popup_list/data",
			data: function(p)
			{				
				p.pPartsNo = $("#pPartsNo").val();
				p.pPartsNoDesc = $("#pPartsNoDesc").val();
				p.pPlant = $("#pPlant").val();
			},
			dataSrc: function(response) 
			{				
				let data = response.RESULT;
				
				for (let i=0, length=data.length; i<length; i++)
				{
					data[i].RAD_MATNR = "";
					data[i].AVA_FLAG = "";
				}
				
				$("#totalRows").html(data.length + " row(s).");
				
				return data;
			}
		},
		initComplete: function() {
			ProgressBar.hide();
		}
	});
	
	// Datatable grid 초기 설정 셋업
	initGridTable($tableObj);		

	// Search 버튼 클릭
	$("#BTN_search").on("click", function(){		
	    if(checkValidation()){		
			doSearch();
	    }
	});
	
	//Input text 엔터 키 입력
	$("#pPartsNo").on("keydown", function(event) {
		
		$(this).val($(this).val().toUpperCase());
		
		if (event.keyCode == 13)
		{
			doSearch();
		};
	});			

	$("#BTN_download").on("click", function(){		
		var gridFileDownload = new GridFileDownload($tableObj);
		gridFileDownload.fileName = "Substitution_List";
		gridFileDownload.excelDownload();	 
	});
	
	$('#TBL_grid tbody').on('click', 'tr', function (e){				
	    var tblGrid = $('#TBL_grid').DataTable();	    
	    var index = $('#TBL_grid').dataTable().api().cell($(e.target).closest('td')).index().column;	    	    
		var rowData = tblGrid.row(this).data();
		console.log(index);		
		console.log(rowData);
		
		var vAM_PART_NO = rowData.AM_PART_NO;		
		if(index == 0){	
			$("input[name=pPartsNo]", opener.document).val(vAM_PART_NO);
			opener.doSearch();
		}					
	});		
});	

function doSearch()
{
	$tableObj.ajax.reload();
}

/*
 * code(parts)변경 popup	 
 */ 	
function searchParts(){
	var param = "pPartsNo=" + $("#pPartsNo").val();
	Popup.open("/portal/corp/eu/scm/parts/info/parts_number_popup_list?" + param, 700, 600);	
}

function checkValidation(){	
    var pPartsNo = $('#pPartsNo').val();
    var rtnValue = 1;
    
    $(".error").remove();
    
    if (pPartsNo.length < 1) {
//    	$('#pPartsNo').after('<span class="error">You have to input the material.</span>');
    	alert("[[#{DIVEU_MSG_0065}]]");	// MSG_0065 You have to input the material.
    	rtnValue = -1;
   	}
    
    if(rtnValue > 0){
    	return true;
    }else{
    	return false;    	
    }    
}

$("#BTN_close").on("click", function(){
	self.close();	
});	
</script>	
</th:block>
