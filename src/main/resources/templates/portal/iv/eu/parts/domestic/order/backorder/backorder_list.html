<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{portal/layout/common/index}">
<th:block layout:fragment="content">
	<script type="application/javascript" th:src="@{/portal/js/portal.utils.order.js}"></script>
	
	<div class="block-header">
		<div class="block-title" th:text="#{DIVEU_TXT_0041}"></div><!-- Backorder List -->
		<div class="block-button-area">
			<button id="BTN_download" type="button" th:text="#{DIVEU_BTN_0003}"></button><!-- Download -->
			<button id="BTN_search" type="button" th:text="#{DIVEU_BTN_0002}"></button><!-- Search -->				
		</div>
	</div>
	<div class="condition-area">
	<form id="FORM_search" name="FORM_search">
	<table class="condition">
		<tbody>
			<tr>
				<th th:text="#{DIVEU_LB_0013}"></th>
				<td>
					<div class="input-area">
						<input type="text" id="pOrderNo" name="pOrderNo" class="custom-ui" th:value="${pOrderNo}">
					</div>			
				</td>
				<th th:text="#{DIVEU_LB_0014}"></th>
				<td>
				<div class="input-area order-type"></div>
				</td>			
			</tr>
			<tr>
				<th th:text="#{DIVEU_LB_0015}"></th>
				<td>
					<div class="input-area">
						<input type="text" id="pPoNo" name="pPoNo" class="custom-ui" th:value="${pPoNo}">
					</div>		
				</td>
				<th th:text="#{DIVEU_LB_0029}"></th>
				<td>
					<div class="input-area">
						<input type="text" id="pOrderPartNo" name="pOrderPartNo" class="custom-ui" th:value="${pOrderPartNo}">
					</div>		
				</td>			
			</tr>		
			<tr>
				<th th:text="#{DIVEU_LB_0016}"></th><!-- Period -->
				<td colspan="3">
					<div class="input-area">
						<input type="text" id="pFromDate" name="pFromDate" class="custom-ui-calendar" th:value="${pFromDate}">
						<div class="split"></div>
						<input type="text" id="pToDate" name="pToDate" class="custom-ui-calendar" th:value="${pToDate}">					
					</div>
				</td>
			</tr>
		</tbody>
	</table>
	</form>
	</div>
	<div class="split-row"></div>
	
	<div class="grid-info">
		<div class="grid-total">
			<div class="split"></div>
			<span class="total-number" id="totalRows"></span>
		</div>
	</div>
	
	<div id="AREA_grid" class="flex-grow grid-area">
		<table id="TBL_grid" class="order-column stripe compact"></table>
	</div>
	
	<script type="application/javascript">
	$(function(){
		let orderComponent = new OrderComponent();
		orderComponent.makeOrderType($(".order-type"), "pOrderType", "");
		
		Calendar.makeBeetweenCalendar($("#pFromDate"), "[[${pFromDate}]]", $("#pToDate"), "[[${pToDate}]]");
			
		$tableObj = $("#TBL_grid").DataTable({
			select: true,   			// row 선택 기능 켬
			ordering: true, 			// 정렬 기능 켬
			scrollY: 100,
			//fixedColumns: { leftColumns: 9 },
			columns : [
				{data: "KONDA_T", 		title: "[[#{DIVEU_LB_0014}]]"},	//Order<br>Type
				{data: "BSTKD", 		title: "[[#{DIVEU_LB_0015}]]"},	//P.O. No.
				{data: "AUDAT", 		title: "[[#{DIVEU_LB_0108}]]"},	//Order Date
				{data: "PRETD",			title: "[[#{DIVEU_LB_0109}]]"},	//ETD Comment
				{data: "VBELN", 		title: "[[#{DIVEU_LB_0013}]]"},	//Order No.
				{data: "POSNR", 		title: "[[#{DIVEU_LB_0019}]]"},	//Line Item 
				{data: "MATNR_SO", 		title: "[[#{DIVEU_LB_0029}]]"},	//Order Part No.
				{data: "MATNR_SH", 		title: "[[#{DIVEU_LB_0030}]]"},	//Supply Part No
				{data: "MAKTX", 		title: "[[#{DIVEU_LB_0031}]]"},	//Description
				{data: "KWMENG_SO", 	title: "[[#{DIVEU_LB_0111}]]"},	//Order Qty
				{data: "KWMENG_SH", 	title: "[[#{DIVEU_LB_0112}]]"},	//S.Completion Qty
				{data: "KWMENG", 		title: "[[#{DIVEU_LB_0113}]]"},	//Backorder quantity
				{data: "VRKME", 		title: "[[#{DIVEU_LB_0049}]]"}	//UoM
			],
			ajax: {
				url: "/portal/corp/eu/scm/parts/order/backorder/backorder_list/data",
				data: function(p)
				{
					p.pOrderNo 		= $("#pOrderNo").val();
					p.pOrderType	= $("#pOrderType").val();
					p.pPoNo 		= $("#pPoNo").val();
					p.pOrderPartNo 	= $("#pOrderPartNo").val();
					p.pFromDate 	= $("#pFromDate").val();
					p.pToDate 		= $("#pToDate").val();				
				},
				dataSrc: function(response) 
				{				
					let data = response.RESULT;
											
					for (let i=0, length=data.length; i<length; i++)
					{
						let etd = $.trim(data[i].PRETD);
						let etdat = $.trim(data[i].ETDAT);					
										
						if (etd == "0000-00-00")
						{
							etd = "";						
						}
						
						data[i].ETDAT = etdat;
						
						let gubun = data[i].GUBUN;
						
						if ("F" == gubun)
						{
							etdDesc = "All available";												
						}
						else if ("P" == gubun)
						{
							etdDesc = "Partially available";												
						}
						else
						{
							if (etd != "")
							{
								etdDesc = etd;								
							}
							else
							{								
								etdDesc = "TBD";								
							}
						}
						
						data[i].PRETD = etdDesc;
					};		
					
					$("#totalRows").html(data.length+" row(s).");
					
					return data;
				}			
			},
			initComplete:function(settings, json) 
			{			
				ProgressBar.hide();
			}
		});
		
		// Datatable grid 초기 설정 셋업
		initGridTable($tableObj);
		
		// Search 버튼 클릭
		$("#BTN_search").on("click", function(){		
			doSearch();			// dataTable의 ajax 설정을 이용해  다시 조회. 
		});
		
		//Input text 엔터 키 입력
		$("#FORM_search input:text").on("keydown", function(event) {
			if (event.keyCode == 13)
			{
				doSearch();
			};
		});	
			
		$("#BTN_download").on("click", function() {
			let gridFileDownload = new GridFileDownload($tableObj);
			gridFileDownload.fileName = "backorder_list";
			gridFileDownload.excelDownload();
		});
		
		function doSearch()
		{
			$tableObj.ajax.reload();
		}	
	});
	
	</script>	
</th:block>