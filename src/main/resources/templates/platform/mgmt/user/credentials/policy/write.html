<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{platform/layout/popup/index}">

<th:block layout:fragment="content">
<form id="FORM_write" class="ui form" autocomplete="off" onsubmit="return false;">
<input type="hidden" id="cpSeq" name="cpSeq" th:value="${credentialsPolicy.cpSeq}"/>
<input type="hidden" id="mode" name="mode" th:value="${mode}"/>
<div class="ui one column grid">
	<div class="column">
		<div class="ui teal button BTN_save"><i class="check icon"></i> Save</div>
		<div class="ui button BTN_back"><i class="arrow left icon"></i> Back</div>
	</div>
</div>
<div class="ui divider"></div>
<div class="ui segment">
	<div class="field">
		<label class="required">Name</label>
		<input type="text" name="name" th:value="${credentialsPolicy.name}" class="uppercase"/>
	</div>
	<div class="field">
		<label>Description</label>
		<textarea name="description" th:text="${credentialsPolicy.description}" rows="3"></textarea>
	</div>
	<div class="field">
		<div class="ui checkbox">
			<input type="checkbox" name="fgUse" class="hidden" th:value="${T(org.jwebppy.platform.core.PlatformCommonVo).YES}" th:checked="${credentialsPolicy.fgUse == T(org.jwebppy.platform.core.PlatformCommonVo).YES}" >
			<label>Use</label>
		</div>
	</div>
	<div class="field" th:if="${isShowFgDefault}">
		<div class="ui checkbox">
			<input type="checkbox" name="fgDefault" class="hidden" th:value="${T(org.jwebppy.platform.core.PlatformCommonVo).YES}" th:checked="${credentialsPolicy.fgDefault == T(org.jwebppy.platform.core.PlatformCommonVo).YES}" >
			<label>Default</label>
		</div>
	</div>	
	<div class="ui secondary pointing menu">
		<a class="active item" data-tab="username">Username</a>
		<a class="item" data-tab="password">Password</a>
	</div>
	<div class="ui tab attached segment teal active" data-tab="username">
		<div class="field">
			<label class="required">Length</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="uminLength" th:value="${credentialsPolicy.uminLength}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="umaxLength" th:value="${credentialsPolicy.umaxLength}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<div class="ui checkbox u-fg-only-lowercase">
				<input type="checkbox" name="ufgOnlyLowercase" class="hidden" th:value="${T(org.jwebppy.platform.core.PlatformCommonVo).YES}" th:checked="${credentialsPolicy.ufgOnlyLowercase == T(org.jwebppy.platform.core.PlatformCommonVo).YES}" >
				<label>Use Only Lower Case</label>
			</div>
		</div>
		<div class="field">
			<label>Lowercase</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" id="uminLowercase" name="uminLowercase" th:value="${credentialsPolicy.uminLowercase}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" id="umaxLowercase" name="umaxLowercase" th:value="${credentialsPolicy.umaxLowercase}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<div class="ui checkbox u-fg-only-uppercase">
				<input type="checkbox" name="ufgOnlyUppercase" class="hidden" th:value="${T(org.jwebppy.platform.core.PlatformCommonVo).YES}" th:checked="${credentialsPolicy.ufgOnlyUppercase == T(org.jwebppy.platform.core.PlatformCommonVo).YES}" >
				<label>Use Only Upper Case</label>
			</div>
		</div>		
		<div class="field">
			<label>Uppercase</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" id="uminUppercase" name="uminUppercase" th:value="${credentialsPolicy.uminUppercase}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" id="umaxUppercase" name="umaxUppercase" th:value="${credentialsPolicy.umaxUppercase}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<label>Number</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="uminNumber" th:value="${credentialsPolicy.uminNumber}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="umaxNumber" th:value="${credentialsPolicy.umaxNumber}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<label>Special</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="uminSpecial" th:value="${credentialsPolicy.uminSpecial}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="umaxSpecial" th:value="${credentialsPolicy.umaxSpecial}" placeholder="Max."/>
				</div>
			</div>
		</div>
	</div>	
	<div class="ui tab attached segment teal" data-tab="password">
		<div class="field">
			<label class="required">Length</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="pminLength" th:value="${credentialsPolicy.pminLength}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="pmaxLength" th:value="${credentialsPolicy.pmaxLength}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<label>Lowercase</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="pminLowercase" th:value="${credentialsPolicy.pminLowercase}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="pmaxLowercase" th:value="${credentialsPolicy.pmaxLowercase}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<label>Uppercase</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="pminUppercase" th:value="${credentialsPolicy.pminUppercase}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="pmaxUppercase" th:value="${credentialsPolicy.pmaxUppercase}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<label>Number</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="pminNumber" th:value="${credentialsPolicy.pminNumber}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="pmaxNumber" th:value="${credentialsPolicy.pmaxNumber}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<label>Special</label>
			<div class="fields">
				<div class="eight wide field">
					<input type="number" name="pminSpecial" th:value="${credentialsPolicy.pminSpecial}" placeholder="Min."/>
				</div>
				<div class="eight wide field">
					<input type="number" name="pmaxSpecial" th:value="${credentialsPolicy.pmaxSpecial}" placeholder="Max."/>
				</div>
			</div>
		</div>
		<div class="field">
			<label>Password Valid Period (Days)</label>
			<input type="number" name="pvalidPeriod" min="0" oninput="validity.valid||(value='');" th:value="${credentialsPolicy.pvalidPeriod}" placeholder="Days"/>
		</div>		
		<div class="field">
			<div class="ui checkbox p-fg-use-pwd-fail-penalty">
				<input type="checkbox" name="fgUsePwdFailPenalty" class="hidden" th:value="${T(org.jwebppy.platform.core.PlatformCommonVo).YES}" th:checked="${credentialsPolicy.fgUsePwdFailPenalty == T(org.jwebppy.platform.core.PlatformCommonVo).YES}" >
				<label>Use Password Failure Penalty</label>
			</div>
		</div>
		<div class="fields">
			<div class="six wide field">
				<label>Allowable Failure Count</label>
				<div class="field">
					<input type="number" name="pallowableFailCount" th:value="${credentialsPolicy.pallowableFailCount}" placeholder="Count"/>
				</div>
			</div>
			<div class="five wide field">
				<label>Checking Duration(sec.)</label>
				<div class="field">
					<input type="number" name="pfailCheckDuration" th:value="${credentialsPolicy.pfailCheckDuration}" placeholder="Duration(Sec.)"/>
				</div>
			</div>
			<div class="five wide field">
				<label>Freezing Duration(sec.)</label>
				<div class="field">
					<input type="number" name="pfreezingDuration" th:value="${credentialsPolicy.pfreezingDuration}" placeholder="Duration(Sec.)"/>
				</div>
			</div>	
		</div>
	</div>
	<div class="ui divider"></div>
	<div class="ui one column grid">
		<div class="column">
			<div class="ui teal button BTN_save"><i class="check icon"></i> Save</div>
			<div class="ui button BTN_back"><i class="arrow left icon"></i> Back</div>
		</div>
	</div>		
</div>
</form>
<script>
//팝업 Title
const POPUP_TITLE = "Credentials Policy";

$(document).ready(function() {
	if (JpUtilsString.equals($("#mode").val(), "copy"))
	{
		$("#cpSeq").val("");
	};	
	
	$(".menu .item").tab();
	$(".ui.checkbox").checkbox();
	
	$(".ui.checkbox.u-fg-only-lowercase").checkbox({
		onChecked: function()
		{
			enabledUsernameOnlyLowercase(true);
		},
		onUnchecked: function()
		{
			enabledUsernameOnlyLowercase(false);
		}
	});
	
	$(".ui.checkbox.u-fg-only-uppercase").checkbox({
		onChecked: function()
		{
			enabledUsernameOnlyUppercase(true);
		},
		onUnchecked: function()
		{
			enabledUsernameOnlyUppercase(false);
		}
	});
	
	function enabledUsernameOnlyLowercase(isEnabled)
	{
		if (isEnabled)
		{
			$(".ui.checkbox.u-fg-only-uppercase").checkbox("uncheck").checkbox("set disabled");
			clickUsernameOnlyLowercase(true);
			clickUsernameOnlyUppercase(true);			
		}
		else
		{
			$(".ui.checkbox.u-fg-only-uppercase").checkbox("uncheck").checkbox("set enabled");
			clickUsernameOnlyLowercase(false);
			clickUsernameOnlyUppercase(false);			
		};
	};
	
	function enabledUsernameOnlyUppercase(isEnabled)
	{
		if (isEnabled)
		{
			$(".ui.checkbox.u-fg-only-lowercase").checkbox("uncheck").checkbox("set disabled");;
			clickUsernameOnlyLowercase(true);
			clickUsernameOnlyUppercase(true);			
		}
		else
		{
			$(".ui.checkbox.u-fg-only-lowercase").checkbox("uncheck").checkbox("set enabled");;
			clickUsernameOnlyLowercase(false);
			clickUsernameOnlyUppercase(false);			
		};
	};
	
	function clickUsernameOnlyLowercase(isChecked)
	{
		if (isChecked)
		{
			$("#uminLowercase").attr("disabled", true).val("");
			$("#umaxLowercase").attr("disabled", true).val("");			
		}
		else
		{
			$("#uminLowercase").attr("disabled", false);
			$("#umaxLowercase").attr("disabled", false);
		};
	};
	
	function clickUsernameOnlyUppercase(isChecked)
	{
		if (isChecked)
		{
			$("#uminUppercase").attr("disabled", true).val("");
			$("#umaxUppercase").attr("disabled", true).val("");			
		}
		else
		{
			$("#uminUppercase").attr("disabled", false);
			$("#umaxUppercase").attr("disabled", false);			
		};
	};
	
	$(".ui.checkbox.p-fg-use-pwd-fail-penalty").checkbox({
		onChecked: function()
		{
			$("input[name=pallowableFailCount], input[name=pfailCheckDuration], input[name=pfreezingDuration]").attr("disabled", false);
		},
		onUnchecked: function()
		{
			let obj = $("input[name=pallowableFailCount], input[name=pfailCheckDuration], input[name=pfreezingDuration]"); 
			let field = obj.closest(".field")
			
			field.removeClass("error");
			field.find(".prompt").remove();
			
			obj.attr("disabled", true).val("");
		}
	});	
	
	$("#FORM_write").form(formValidCheck);
	
	$(".BTN_save").on("click", function() {
		if ($("#FORM_write").form("validate form"))
		{
			JpUtilsAjax.post({
				url: "/platform/mgmt/user/credentials/policy/save",
				data: $("#FORM_write").serialize(),
				success: function(data, textStatus, jqXHR)
				{
					if (data.RESULT > 0)
					{
						try
						{
							opener.doSearch();
						}
						catch (e) {}
						
						goBack();
					};
				}
			});
		};			
	});
	
	if (JpUtilsString.equals("[[${credentialsPolicy.ufgOnlyLowercase}]]", "Y"))
	{
		enabledUsernameOnlyLowercase(true);
	};
	
	if (JpUtilsString.equals("[[${credentialsPolicy.ufgOnlyUppercase}]]", "Y"))
	{
		enabledUsernameOnlyUppercase(true);
	};
	
	$(".BTN_back").on("click", function() {
		goBack();
	});
	
	function goBack()
	{
		document.location.href = JpUtilsPath.url("/platform/mgmt/user/credentials/policy/view?cpSeq=[[${cpSeq}]]");		
	};
});

let formValidCheck = {
		inline: true,
		fields: {
			Name: {
				identifier: "name",
				rules: [
					{
						type: "empty",
						prompt: "Please enter Name."
					},
					{
						type: "checkName",
						prompt: "The name is not available. Please enter another one."
					}					
				]
			},
			uminLength: {
				identifier: "uminLength",
				rules: [
					{
						type: "empty",
						prompt: "Please enter a minimum length of username."
					}
				]
			},
			umaxLength: {
				identifier: "umaxLength",
				rules: [
					{
						type: "empty",
						prompt: "Please enter a maximum length of username."
					}
				]
			},
			pminLength: {
				identifier: "pminLength",
				rules: [
					{
						type: "empty",
						prompt: "Please enter a minimum length of password."
					}
				]
			},
			pmaxLength: {
				identifier: "pmaxLength",
				rules: [
					{
						type: "empty",
						prompt: "Please enter a maximum length of password."
					}
				]
			},
			pallowableFailCount: {
				identifier: "pallowableFailCount",
				rules: [
					{
						type: "checkAllowableFailCount",
						prompt: "Please input Allowable Failure Count."
					}
				]
			},
			pfailCheckDuration: {
				identifier: "pfailCheckDuration",
				rules: [
					{
						type: "checkFailCheckDuration",
						prompt: "Please input Check Duration(sec.)."
					}
				]
			},
			pfreezingDuration: {
				identifier: "pfreezingDuration",
				rules: [
					{
						type: "checkFreezingDuration",
						prompt: "Please input Freezing Duration(sec.)."
					}
				]
			}
		},
		keyboardShortcuts: false
};

$.fn.form.settings.rules.checkName = function() {
	let name = $("#FORM_write input[name=name]").val();
	
	if (JpUtilsString.isEmpty(name))
	{
		return false;		
	};
	
	let isValid = false;
	
	JpUtilsAjax.get({
		url: "/platform/mgmt/user/credentials/policy/check/valid_name",
		data: { cpSeq: $("#cpSeq").val(), name: name },
		global: false,
		async: false,
		success: function(data, textStatus, jqXHR)
		{
			let result = data.RESULT;
			
			if (result == "S")
			{
				isValid = true;
			};
		}
	});

	return isValid;	
};

function isCheckedPwdFailPenalty()
{
	return $(".ui.checkbox.p-fg-use-pwd-fail-penalty").checkbox("is checked");
};

$.fn.form.settings.rules.checkAllowableFailCount = function() {
	if (isCheckedPwdFailPenalty() && JpUtilsString.isEmpty($("input[name=pallowableFailCount]").val()))
	{
		return false;		
	};
		
	return true;
};

$.fn.form.settings.rules.checkFailCheckDuration = function() {
	if (isCheckedPwdFailPenalty() && JpUtilsString.isEmpty($("input[name=pfailCheckDuration]").val()))
	{
		return false;		
	};
		
	return true;
};

$.fn.form.settings.rules.checkFreezingDuration = function() {
	if (isCheckedPwdFailPenalty() && JpUtilsString.isEmpty($("input[name=pfreezingDuration]").val()))
	{
		return false;		
	};
		
	return true;
};	
</script>
</th:block>
</html>